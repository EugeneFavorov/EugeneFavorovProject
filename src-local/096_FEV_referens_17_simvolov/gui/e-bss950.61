DEFINE VARIABLE vStError AS CHARACTER   NO-UNDO.
vStError =  FGetSetting("SWIFT","st-err","В").

IF zop NE '' THEN /*ведущий*/
   FIND FIRST op-impexp WHERE op-impexp.op EQ INT64(zop) NO-LOCK NO-ERROR.
ELSE FIND FIRST op-impexp OF op NO-LOCK NO-ERROR. /*сводный*/
ASSIGN
   buf-s = IF in-currency EQ "" THEN
              TRIM(STRING({&pre}op-entry.amt-rub,"->>>>>>>>>>>9.99"))  
           ELSE TRIM(STRING({&pre}op-entry.amt-cur,"->>>>>>>>>>>9.99"))
   overlay(buf-s,INDEX(buf-s,"."),1) = ",".

IF topen.db THEN
DO:
   buf-ref = IF AVAIL op-impexp AND
                op-impexp.op-referenc NE ""
             THEN op-impexp.op-referenc
             ELSE "NONREF".
   IF buf-ref NE "NONREF" THEN
      FIND FIRST msg-impexp WHERE
                 msg-impexp.msg-cat   EQ "op"          AND
                 msg-impexp.object-id EQ STRING(op.op) AND
                 msg-impexp.msg-type  BEGINS "i"       AND
             NOT msg-impexp.msg-type  MATCHES("*950*") NO-LOCK NO-ERROR.
   ELSE DO:
      FIND msg-impexp where
           msg-impexp.msg-cat   EQ "op"          AND
           msg-impexp.object-id EQ STRING(op.op) AND
           msg-impexp.msg-type  BEGINS "e"       AND
           msg-impexp.msg-type  MATCHES("*900*") NO-LOCK NO-ERROR.
      IF NOT AMBIGUOUS msg-impexp THEN
      DO:
         FIND FIRST msg-impexp where
                    msg-impexp.msg-cat   EQ "op"          AND
                    msg-impexp.object-id EQ STRING(op.op) AND
                    msg-impexp.msg-type  BEGINS "e"       AND
                    msg-impexp.msg-type  MATCHES("*900*") NO-LOCK NO-ERROR.
         buf-ref = IF AVAIL op-impexp AND
                     op-impexp.bank-referenc NE ""
                   THEN op-impexp.bank-referenc
                   ELSE "NONREF".
      END.
   END.
END.
ELSE DO:
   buf-ref = IF AVAIL op-impexp AND
                op-impexp.bank-referenc NE ""
             THEN op-impexp.bank-referenc
             ELSE "NONREF".
   FIND FIRST msg-impexp where 
              msg-impexp.msg-cat   EQ "op"          AND
              msg-impexp.object-id EQ string(op.op) AND 
              msg-impexp.msg-type  BEGINS "e"       AND
          NOT msg-impexp.msg-type  MATCHES("*195*") AND
          NOT msg-impexp.msg-type  MATCHES("*196*") AND
          NOT msg-impexp.msg-type  MATCHES("*940*") AND
          NOT msg-impexp.msg-type  MATCHES("*950*") AND
          NOT msg-impexp.msg-type  MATCHES("*900*") NO-LOCK NO-ERROR.
END.

ASSIGN
   buf-ref = IF LENGTH(buf-ref) > 18 then
                SUBSTR(buf-ref,LENGTH(buf-ref) - 17)
             ELSE buf-ref
   buf-work =
      ":61:" +
      {date-swf.i
       &date="IF {&pre}op-entry.op-date EQ ?
              THEN {&pre}xop-entry.op-date
              ELSE {&pre}op-entry.op-date"
      } + "{&pre}" +
      (IF topen.db then "D" else "C") + buf-s +
      (IF AVAIL msg-impexp AND LENGTH(msg-impexp.msg-type) > 3 
       THEN "S" + SUBSTR(msg-impexp.msg-type,LENGTH(msg-impexp.msg-type) - 2,3) 
       ELSE "NMSC") 
      + buf-ref +
      (IF AVAIL op-impexp AND
          buf-ref NE op-impexp.bank-referenc AND
          op-impexp.bank-referenc NE ""
       THEN ("//" +
             (IF LENGTH(op-impexp.bank-referenc) > 16 THEN
                 SUBSTR(op-impexp.bank-referenc,LENGTH(op-impexp.bank-referenc) - 15)
              ELSE op-impexp.bank-referenc)
            )
       ELSE ""
      ).
v[10] = GetXattrValueEx('op-kind',op-kind.op-kind,'code-err','mess-error').
IF AVAIL op-impexp AND
   (LENGTH(op-impexp.bank-referenc) > 16 OR
    LENGTH(op-impexp.op-referenc) > 16
   ) AND
   FChkClsDate(IF {&pre}op-entry.op-date EQ ? THEN
                  {&pre}xop-entry.op-date
               ELSE {&pre}op-entry.op-date , mCats) EQ NO AND
   getcode(v[10],'swift-61-01') NE ''
   THEN
DO:
   FIND FIRST z-op OF op-impexp EXCLUSIVE-LOCK NO-WAIT NO-ERROR.
   IF AVAIL z-op THEN DO:
      {additem.i
         "z-op.op-error"
         "v[10] + ':swift-61-01'"
      }
      IF getcode(v[10],'swift-61-01') EQ 'Ошибка' THEN
      DO:
         z-op.op-status = vStError.
         FOR EACH z-op-entry Of z-op EXCLUSIVE-LOCK:
            z-op-entry.op-status = z-op.op-status.
         END.
      END.
   END.
END.
RUN cr-buf-copy-doc(buf-work).
