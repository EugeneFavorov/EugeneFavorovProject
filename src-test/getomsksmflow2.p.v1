/*
              Банковская интегрированная система БИСквит
 Copyright:
 Filename:    getomsksmflow2.p
 Comment:     загрузка заготовок смартфлоу в БИС
 Parameters:
 Uses:
 Used by:
 Created:
 Modified:
*/

/*
ROUTINE-LEVEL ON ERROR UNDO, THROW.
*/

{globals.i}
{intrface.get xclass}
/* {getomsksmflow.i} */

DEF INPUT PARAMETER iForm AS CHAR.
DEF OUTPUT PARAMETER outHandle AS CHAR.
DEF VAR bb AS LOGICAL NO-UNDO.

DEF TEMP-TABLE tt-smflow LIKE bank.smartflow.
    
    
    /*FIELD did       AS INT64
    FIELD doc-type  AS CHAR
    FIELD doc-num   AS CHAR
    FIELD doc-date  AS DATE
    FIELD ben-acct  AS CHAR
    FIELD name-ben  AS CHAR
    FIELD acct-cat  AS CHAR
    FIELD details   AS CHAR
    FIELD inn       AS CHAR
    FIELD inn-send  AS CHAR
    FIELD acct-send AS CHAR
    FIELD name-send AS CHAR
    FIELD inn-rec   AS CHAR
    FIELD acct-rec  AS CHAR
    FIELD name-rec  AS CHAR /* op */
    
    FIELD okato     AS CHAR
    FIELD kpp-send  AS CHAR
    FIELD kpp-rec   AS CHAR
    FIELD pokst     AS CHAR
    FIELD kbk       AS CHAR
    FIELD pokop     AS CHAR
    FIELD poknp     AS CHAR
    FIELD poknd     AS CHAR
    FIELD pokdd     AS CHAR
    FIELD poktp     AS CHAR
    FIELD docum     AS CHAR
    FIELD docum-id  AS CHAR
    FIELD class-code AS CHAR /* signs for op */
    
    FIELD bank-code AS CHAR
    FIELD corr-acct AS CHAR /* op-bank */
    
    FIELD currency  AS CHAR
    FIELD acct-db   AS CHAR
    FIELD acct-cr   AS CHAR
    FIELD amt-rub   AS CHAR
    FIELD symbol    AS CHAR /* op-entry */
    */
    .
    
{empty tt-smflow}    

IF iForm = 'YES' THEN DO:    
    end-date = TODAY.
    {getdate.i
    &DateLabel = "Дата загрузки"
    &DateHelp  = "(F1 - календарь)"
    &NoInit    = "YES"
    }


FOR EACH bank.smartflow WHERE 
    bank.smartflow.idate >= end-date AND bank.smartflow.idate < (end-date + 1)
    NO-LOCK QUERY-TUNING ( NO-INDEX-HINT)
        :
           bb = TRUE.
           FOR EACH signs WHERE signs.file-name = 'op'
             AND signs.code = 'did-smartfl' 
             AND signs.dec-value = bank.smartflow.did NO-LOCK:
               FIND FIRST op WHERE op.op = INT64(signs.surrogate) AND op.op-status > 'А' NO-LOCK NO-ERROR.
               IF AVAIL op THEN DO:
                   bb = FALSE.
               END.
           END.
           IF bb THEN DO:
                CREATE tt-smflow.
                BUFFER-COPY bank.smartflow TO tt-smflow.
           END.          
           
END.

/*
run instview.p(TEMP-TABLE tt-smflow:HANDLE).    
  */  

    
/*объявляем handle для передачи temp-table в УТ*/
DEF NEW SHARED VAR hO-tt AS HANDLE NO-UNDO.
DEF VAR hO-b    AS HANDLE NO-UNDO.
DEF VAR hO-btt  AS HANDLE NO-UNDO.

/*заполняем таблицу для УТ*/
hO-b = BUFFER tt-smflow:HANDLE.

CREATE TEMP-TABLE hO-tt.
hO-tt:CREATE-LIKE("tt-smflow").
hO-tt:TEMP-TABLE-PREPARE("xtt-smflow").

hO-btt = hO-tt:DEFAULT-BUFFER-HANDLE.

FOR EACH tt-smflow:
  hO-btt:BUFFER-CREATE.
  hO-btt:BUFFER-COPY(hO-b).
END.

  outHandle = STRING(hO-tt).


END.

IF iForm = 'NO' THEN DO:
    DELETE OBJECT hO-tt.
END.    
    
