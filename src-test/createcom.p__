/*
                ­ª®¢áª ï ¨­â¥£à¨à®¢ ­­ ï á¨áâ¥¬  ˆ‘ª¢¨â
    Copyright: (C) 1992-2010 ‡€Ž " ­ª®¢áª¨¥ ¨­ä®à¬ æ¨®­­ë¥ á¨áâ¥¬ë"
     Filename: 
      Comment: 
   Parameters:  
      Created: fev
*/

{globals.i}                           
{sh-defs.i}
{intrface.get xclass}
{intrface.get instrum}
{flt-val.i}
{intrface.get tmess}
{tmprecid.def}

/*&GLOBAL-DEFINE FILE_sword_p YES
{pp-uni.var}
&UNDEFINE FILE_sword_p
{pp-uni.prg}
{prn-doc.def &with_proc=YES}*/

DEFINE INPUT PARAMETER iParms AS CHARACTER NO-UNDO.
                 
DEF BUFFER bop         FOR op.
DEF BUFFER bbop        FOR op.
DEF BUFFER bbbop       FOR op.
DEF BUFFER bop-bank    FOR op-bank.
DEF BUFFER bbop-bank   FOR op-bank.
DEF BUFFER bop-entry   FOR op-entry.
DEF BUFFER bbop-entry  FOR op-entry.
DEF BUFFER bbbop-entry FOR op-entry.
DEF BUFFER bsigns      FOR signs.
DEF BUFFER blinks      FOR links.
DEF BUFFER bacct       FOR acct.
DEF BUFFER bbacct      FOR acct.
DEF BUFFER btmpsigns   FOR tmpsigns.
DEF BUFFER btmpsigns2  FOR tmpsigns.

DEF VAR i1       AS DECIMAL NO-UNDO.
DEF VAR i2       AS DECIMAL NO-UNDO.
DEF VAR i3       AS DECIMAL NO-UNDO.
DEF VAR i4       AS DECIMAL NO-UNDO.
DEF VAR flag     AS DECIMAL NO-UNDO.
DEF VAR date1    AS DATE FORMAT 99/99/9999 NO-UNDO.
DEF VAR date2    AS DATE FORMAT 99/99/9999 NO-UNDO.
DEF VAR stat     AS CHAR NO-UNDO FORM "x(4)".
DEF VAR cust-cat AS CHAR NO-UNDO.
DEF VAR nomdok   AS CHAR NO-UNDO.

DEF STREAM ws.

OUTPUT STREAM ws TO "./_createcom.txt"  
                 CONVERT  TARGET "1251"  SOURCE "IBM866".

                                                       
                                                                 
PAUSE 0.

FORM
date1 label "‚¢¥¤¨â¥ „ âã"

with frame www overlay side-labels 1 col centered row 6 title
color bright-white
"[ " + "CreateCom Window " + "]" width 34.

DO on endkey undo, return on error undo, retry with frame www:
DISPLAY date1.
SET 
 date1
editing:
readkey.
apply lastkey.
END.
END.                                                                                        
DO on endkey undo, leave on error undo, leave with frame prn:



message("‘¥ªã­¤®çªã...").

{setdest.i &col=170}



i1 = 1.
stat = ''.
cust-cat = ''.
nomdok = ''.

PUT STREAM ws UNFORMATTED chr(13) + chr(10).
PUT STREAM ws UNFORMATTED " ”ˆ‹ˆ€‹ " + shFilial + chr(13) + chr(10).
PUT STREAM ws UNFORMATTED chr(13) + chr(10).
PUT STREAM ws UNFORMATTED " „ŽŠ“Œ…’› Ž ŠŽ’Ž›Œ „Ž‹†€ ›’œ ‘ˆ‘€€ ŠŽŒˆ‘‘ˆŸ:" + chr(13) + chr(10).
PUT STREAM ws UNFORMATTED chr(13) + chr(10).
PUT STREAM ws UNFORMATTED " ---------------------------------------------------------------------------------------------------------------------------------------------------- " + chr(13) + chr(10).
PUT STREAM ws UNFORMATTED "|  / |   „€’€   |  ü „ŽŠ  |      ‘—ð’ „……’€     |      ‘—ð’ Š…„ˆ’€    |   ‘“ŒŒ€ „ŽŠ  | ‘’€’ |   ‘“ŒŒ€ ŠŽŒ  | ü ŠŽŒ „ŽŠ |     ’€ˆ”    |   „€’€   |" + chr(13) + chr(10).
PUT STREAM ws UNFORMATTED "|------|----------|---------|----------------------|----------------------|--------------|------|--------------|-----------|--------------|----------|" + chr(13) + chr(10).

/*date1 = DATE('04/06/2015').*/

FOR EACH bop WHERE bop.op-date EQ date1
               AND bop.filial-id EQ shFilial
               AND can-do('01Š‹', bop.doc-type)
               AND can-do('*klb*', bop.op-kind)
               AND can-do('!401*,!402*,!403*,!404*,*', bop.ben-acct)
               NO-LOCK BY bop.op-date:  

    FOR EACH bop-entry WHERE bop-entry.op-date EQ bop.op-date
                         AND bop-entry.filial-id EQ shFilial
                         AND bop-entry.op EQ bop.op
                         AND can-do('!30223*,!40817*,!40821*,!40702810500400010846     @0500,402*,405*,406*,407*,408*', bop-entry.acct-db)
                         AND can-do('30102*,30110*,30223*,30301*', bop-entry.acct-cr)
                         AND ((can-do('!01,!02,*', bop.order-pay)) OR (can-do('!‚,!"",*', bop-entry.type)))
                         NO-LOCK:

        FIND FIRST bacct WHERE bacct.acct EQ bop-entry.acct-db
                         NO-LOCK NO-ERROR.

        IF bacct.cust-cat EQ 'ž' THEN cust-cat = 'cust-corp'.
                                 ELSE cust-cat = 'person'.

        FIND LAST btmpsigns WHERE btmpsigns.code      EQ ' ª¥â'
                              AND btmpsigns.file-name EQ cust-cat
                              AND btmpsigns.surrogate EQ string(bacct.cust-id)
                              NO-LOCK NO-ERROR.

        FIND LAST btmpsigns2 WHERE btmpsigns2.code      EQ '’ à¨ä­ë©« ­'
                               AND btmpsigns2.file-name EQ cust-cat
                               AND btmpsigns2.surrogate EQ string(bacct.cust-id)
                               NO-LOCK NO-ERROR.
             
        FIND FIRST bop-bank WHERE bop-bank.bank-code-type EQ 'Œ”Ž-9'
                              AND bop-bank.op             EQ bop.op
                              AND can-do('!044525129,!047106641,!045209884,!"",*', bop-bank.bank-code)
                              NO-LOCK NO-ERROR.

        IF AVAIL bop-bank THEN DO:
                                  FIND FIRST bsigns WHERE bsigns.surrogate EQ STRING(bop.op)
                                                      AND bsigns.file-name EQ 'op'
                                                      AND bsigns.code      EQ '‘¯®á®¡®«ãç'
                                                      NO-LOCK NO-ERROR.

                                  IF AVAIL bsigns THEN DO:
                                                          stat = bop-entry.op-status.
                                                          IF bop-entry.op-status EQ 'û' THEN stat = 'V'.
                                                          IF bop-entry.op-status EQ 'ûû' THEN stat = 'VV'.                                         
                                                          PUT STREAM ws UNFORMATTED "| " + string(i1, ">>>9") + " | " + string(bop.op-date, "99/99/99") + " | " + string(bop.doc-num, "9999999") + " | " + substr(string(bop-entry.acct-db),1,20) +  " | " + substr(string(bop-entry.acct-cr),1,20) + " | " + string(bop-entry.amt-rub, ">>>>>>>>9.99") + " | " + string(stat, "9999") + " | ".

                                                          FOR EACH blinks WHERE blinks.beg-date  >= DATE('04/06/2015')
                                                                            AND blinks.link-id   EQ 480
                                                                            AND blinks.source-id =  STRING(bop.op)
                                                                            NO-LOCK: 
                                                              LEAVE.
                                                          END.

                                                          FIND FIRST bbop-entry WHERE bbop-entry.op-date    EQ date1
                                                                                  AND STRING(bbop-entry.op) EQ blinks.target-id
                                                                                  NO-LOCK NO-ERROR.
                                                          
                                                          FIND FIRST bbbop WHERE bbbop.op EQ bbop-entry.op
                                                                         NO-LOCK NO-ERROR.

                                                          IF AVAIL bbbop THEN nomdok = bbbop.doc-num.
                                                                         ELSE nomdok = ''.






i3 = 0.
i4 = 0.

FOR EACH bbacct WHERE bbacct.cust-cat  =  bacct.cust-cat
                  AND bbacct.filial-id EQ shFilial
                  AND bbacct.cust-id   =  bacct.cust-id
                  AND bbacct.contract  =  ' áç¥â'
                  NO-LOCK:

    FOR EACH bbbop-entry WHERE bbbop-entry.acct-db    EQ bbacct.acct
                           AND bbbop-entry.filial-id  EQ shFilial
                           AND (bbbop-entry.op-status BEGINS 'û' OR bbbop-entry.op-status EQ '”' OR bbbop-entry.op-status EQ '”„„')
                           AND bbbop-entry.op-date    >= DATE('01' + SUBSTRING(STRING(date1),3))
                           AND bbbop-entry.op-date    <= date1
                           AND (bbbop-entry.acct-cr   BEGINS '30102'
                            OR bbbop-entry.acct-cr    BEGINS '30301'
                            OR (bbbop-entry.acct-cr   BEGINS '30223' AND SUBSTRING(bbbop-entry.acct-cr,20,1) EQ '1'))
                           NO-LOCK:

        FIND bbop WHERE bbop.op EQ bbbop-entry.op NO-LOCK NO-ERROR.

        IF AVAIL bbop 
             AND CAN-DO('01Š‹,01“Œ', bbop.doc-type)
             AND NOT bbop.ben-acct BEGINS '40101'
             AND NOT bbop.ben-acct BEGINS '40102'
             AND NOT bbop.ben-acct BEGINS '40201'
             AND NOT bbop.ben-acct BEGINS '40204'
             AND NOT bbop.ben-acct BEGINS '40402'
         THEN DO:

                 FIND FIRST bbop-bank WHERE bbop-bank.op             EQ bbop.op 
                                        AND bbop-bank.bank-code-type EQ 'Œ”Ž-9'
                                        AND bbop-bank.bank-code      NE '044525129'
                                        AND bbop-bank.bank-code      NE '047106641'
                                        AND bbop-bank.bank-code      NE '045209884'
                                        NO-LOCK NO-ERROR.
     
                 IF NOT AVAIL bbop-bank THEN NEXT.
         END.
        ELSE NEXT.
    
    i3 = i3 + 1.
    
    IF bbbop-entry.op-date EQ date1 THEN i4 = i4 + 1.
    
    END.

END.





                                                          IF AVAIL bbop-entry THEN DO: 
                                                                                      PUT STREAM ws UNFORMATTED string(bbop-entry.amt-rub, ">>>>>>>>9.99") + " | " + string(nomdok, "x(9)") + " | ".
                                                                                      flag = 1.
                                                                                   END.
                                                                              ELSE DO:
                                                                                      PUT STREAM ws UNFORMATTED "­¥â ª®¬¨áá¨¨ |           | ".
                                                                                      flag = 0.  
                                                                                   END.  

                                                          IF AVAIL btmpsigns 
                                                               AND btmpsigns.xattr-value NE '' THEN PUT STREAM ws UNFORMATTED string(btmpsigns.xattr-value, "x(12)") + " | " + string(i3, ">>>>>>9") + " | " + chr(13) + chr(10).
                                                                                               ELSE DO: IF AVAIL btmpsigns2 
                                                                                                             AND btmpsigns2.xattr-value NE ''
                                                                                                        THEN PUT STREAM ws UNFORMATTED string(btmpsigns2.xattr-value, "x(12)") + " | " + string(btmpsigns2.since, "99/99/99") + " | " + chr(13) + chr(10).
                                                                                                        ELSE PUT STREAM ws UNFORMATTED "             |          |" + chr(13) + chr(10).
                                                                                                    END.
                                                          i1 = i1 + 1.
                                                       END.
                               END. 
    END.
END.

PUT STREAM ws UNFORMATTED " ---------------------------------------------------------------------------------------------------------------------------------------------------- " + chr(13) + chr(10).


/*
i2 = 0.

FOR EACH bop WHERE bop.op-date EQ date1
               AND bop.filial-id EQ shFilial
               AND bop.op-kind EQ 'CreateCom'
               NO-LOCK BY bop.op-date:  
    i2 = i2 + 1.        
END.

i1 = i1 - 1.
*/

PUT STREAM ws UNFORMATTED chr(13) + chr(10).
PUT STREAM ws UNFORMATTED chr(13) + chr(10).

/*
IF i1 <> i2 THEN PUT STREAM ws UNFORMATTED "ŠŽ‹ˆ—…‘’‚Ž ŠŽŒˆ‘‘ˆŽ›• „ŽŠ“Œ…’Ž‚ (" + string(i2) + ") ‡€ „…œ " + string(date1, "99/99/9999") + " … ‘Ž‚€„€…’ ‘ ŠŽ‹ˆ—…‘’‚ŽŒ Ž‘’“ˆ‚˜ˆ• „ŽŠ“Œ…’Ž‚ (" + string(i1) + ")!" + chr(13) + chr(10).
*/

PUT STREAM ws UNFORMATTED chr(13) + chr(10).



i1 = 1.

PUT STREAM ws UNFORMATTED " ‚‘… ŠŽŒˆ‘‘ˆˆ ‡€ „…œ:" + chr(13) + chr(10).
PUT STREAM ws UNFORMATTED chr(13) + chr(10).
PUT STREAM ws UNFORMATTED " --------------------------------------------------------------------------------------------- " + chr(13) + chr(10).
PUT STREAM ws UNFORMATTED "|  / |   „€’€   | ü ŠŽŒ |      ‘—ð’ „……’€     |      ‘—ð’ Š…„ˆ’€    | ‘’€’ |   ‘“ŒŒ€ ŠŽŒ  |" + chr(13) + chr(10).
PUT STREAM ws UNFORMATTED "|------|----------|-------|----------------------|----------------------|------|--------------|" + chr(13) + chr(10).

FOR EACH bop WHERE bop.op-date EQ date1
               AND bop.filial-id EQ shFilial
               AND bop.op-kind EQ 'CreateCom'
               NO-LOCK BY bop.op-date:  

    FOR EACH bop-entry WHERE bop-entry.op-date EQ bop.op-date
                         AND bop-entry.filial-id EQ shFilial
                         AND bop-entry.op EQ bop.op
                         /* AND can-do('70601810001012102602*', bop-entry.acct-cr) */
                         NO-LOCK:

        IF AVAIL bop-entry THEN
                             DO:
                                stat = bop-entry.op-status.
                                IF bop-entry.op-status EQ 'û' THEN stat = 'V'.
                                IF bop-entry.op-status EQ 'ûû' THEN stat = 'VV'.                                         

                                FOR EACH blinks WHERE blinks.beg-date >= DATE('04/06/2015')
                                                  AND blinks.link-id EQ 480
                                                  AND blinks.target-id = STRING(bop-entry.op)
                                                  NO-LOCK: 
                                    LEAVE.
                                END.

                                IF AVAIL blinks THEN

                                FIND FIRST bbop-entry WHERE bbop-entry.op-date EQ date1
                                                        AND STRING(bbop-entry.op) EQ blinks.source-id
                                                        NO-LOCK NO-ERROR.

                                IF AVAIL bbop-entry THEN PUT STREAM ws UNFORMATTED "| " + string(i1, ">>>9") + " | " + string(bop.op-date, "99/99/99") + " | " + string(bop.doc-num, "99999") + " | " + substr(string(bop-entry.acct-db),1,20) +  " | " + substr(string(bop-entry.acct-cr),1,20) + " | " + string(stat, "9999") + " | " + string(bop-entry.amt-rub, ">>>>>>>>9.99") + " | " + chr(13) + chr(10).
                                                    ELSE PUT STREAM ws UNFORMATTED "| " + string(i1, ">>>9") + " | " + string(bop.op-date, "99/99/99") + " | " + string(bop.doc-num, "99999") + " | " + substr(string(bop-entry.acct-db),1,20) +  " | " + substr(string(bop-entry.acct-cr),1,20) + " | " + string(stat, "9999") + " | " + string(bop-entry.amt-rub, ">>>>>>>>9.99") + " | " + " (­¥â ¨áå®¤­®£® ¤®ªã¬¥­â  á ª®¤®¬ ®¯¥à æ¨¨ " + string(blinks.source-id) + " ¢ ®¯¥à.¤­¥ " + string(date1) + "!)" + chr(13) + chr(10).

                                i1 = i1 + 1.
                             END.
    END.
END.

PUT STREAM ws UNFORMATTED " --------------------------------------------------------------------------------------------- " + chr(13) + chr(10).



OUTPUT STREAM ws CLOSE.

/*{preview.i &col=170}*/

RUN sndbispc ("file=./_createcom.txt;class=bq").

END.