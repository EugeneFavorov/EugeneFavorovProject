/* Комиссия за СпецСчета */
/* fev */

{globals.i}
{pp-corr.p}
{sh-defs.i}
{ksh-defs.i NEW}

DEF VAR nameCl  AS char  no-undo.
DEF VAR tmpdate AS date  no-undo.
DEF VAR opdate  AS date  no-undo.
DEF VAR time16  AS int64 no-undo.

DEF VAR mFlag   AS INT  NO-UNDO.
DEF VAR mSum    AS DEC  NO-UNDO INIT 0.
DEF VAR mKolDocZagrTarif AS DEC  NO-UNDO INIT 0.

DEF VAR fname AS CHAR NO-UNDO.

DEFINE INPUT PARAMETER iForm AS CHAR.

DEF new shared stream vvs.

DEF BUFFER bacct      FOR acct.
DEF BUFFER bop        FOR op.
DEF BUFFER bop2       FOR op.
DEF BUFFER bop-entry  FOR op-entry.
DEF BUFFER bop-entry2 FOR op-entry.
  
DEFINE TEMP-TABLE otchet
        FIELD first_date         AS DATE                /* первая дата */
        FIELD second_date        AS DATE                /* вторая дата */
        FIELD acct_cl            AS CHAR                /* счёт клиента */
        FIELD name_cl            AS CHAR                /* наименование клиента */
        FIELD count_klb_do_16    AS INT64               /* количество КЛБ проводок до 16:00 */
        FIELD count_bum_do_16    AS INT64               /* количество БУМ проводок до 16:00 */
        FIELD count_klb_posle_16 AS INT64               /* количество КЛБ проводок после 16:00 */
        FIELD count_bum_posle_16 AS INT64               /* количество БУМ проводок после 16:00 */
        FIELD count_small        AS INT64
        FIELD count_big          AS INT64
        FIELD count_both         AS INT64
        FIELD count_zagrad_tarif AS INT64
        FIELD sum1               AS DEC
        FIELD sum2               AS DEC
        FIELD kom1               AS CHAR
        FIELD kom2               AS CHAR
        INDEX acct_cl acct_cl       
    .

IF iForm NE 'NO' THEN DO:

  {empty otchet}
      
  fname = "./otchet_spec_acct"  + "_" + userid('bisquit') + ".xml".

  opdate   = date(getsysconf("OpDate")).
  tmpdate  = date(month(opdate),1,year(opdate)).
  beg-date = tmpdate.
  end-date = date_correct(month(opdate),0,31,year(opdate)).
   
  {getdates.i
  &NoInit  = "YES"
  }



  for each acct where can-do("СпБрок,СпецПА,Кон138,КонЗдт,КонРез", acct.contract)
                  and acct.acct begins "40"
                  and acct.acct-cat = "b"
                  and (acct.close-date = ? or acct.close-date >= beg-date)
      no-lock:
               for each op-entry where op-entry.filial-id = shFilial
                                   and op-entry.acct-db = acct.acct
                                   and can-do('30102*,30110*,30223*,30301*', op-entry.acct-cr)
                   no-lock:
                            find first op where op.op = op-entry.op
                                            and op.op-date >= beg-date
                                            and op.op-date <= end-date
                                            and can-do('*klb*,*bum*', op.op-kind)
                                            and can-do('!40101*,!40102*,!40201*,!40204*,!40402*,*', op.ben-acct)
                                            and can-do('01*', op.doc-type)
                                            and op.op-status begins "√"
                                            and op.filial-id = shfilial
                                 no-lock no-error.

      if avail op
         then
              do:
                  /*MESSAGE op-entry.acct-db "№" op.doc-num view-as alert-box.*/

                  /*=============================== Тарифный план Тест-драйв ================================*/
                  if acct.cust-cat EQ "Ю" 
                     AND GetXAttrValueEx("cust-corp", string(acct.cust-id), "ТарифныйПлан", "") = "Тест-драйв"
                     AND can-do('*klb*', op.op-kind)
                  then do: FIND FIRST tmpsigns WHERE tmpsigns.file-name EQ "cust-corp"
                                                 AND tmpsigns.surrogate EQ STRING(acct.cust-id)
                                                 AND tmpsigns.code      EQ "ТарифныйПлан" NO-LOCK NO-ERROR.
                           /*message "Ю" string(op.op-kind) string(op.op) view-as alert-box.*/
                           IF today <= tmpsigns.since + 90
                           THEN NEXT.
                       end.

                  if acct.cust-cat EQ "Ч"
                     AND GetXAttrValueEx("person", string(acct.cust-id), "ТарифныйПлан", "") = "Тест-драйв"
                     AND can-do('*klb*', op.op-kind)
                  then do: FIND FIRST tmpsigns WHERE tmpsigns.file-name EQ "person"
                                                 AND tmpsigns.surrogate EQ STRING(acct.cust-id)
                                                 AND tmpsigns.code      EQ "ТарифныйПлан" NO-LOCK NO-ERROR.
                           /*message "Ч" string(op.op-kind) string(op.op) view-as alert-box.*/
                           IF today <= tmpsigns.since + 90
                           THEN NEXT.
                       end.
                  /*========================================== end ==========================================*/                 

                  /*message string(op.op-date) " " string(op.doc-num) " " string(op-entry.amt-rub) string(op-entry.acct-db) string(acct.details) view-as alert-box.*/
                  find first history where history.file-name = "op"
                                       and history.field-ref = string(op-entry.op)
                                           no-lock no-error.
                  if avail history
                     then 
                          do:
                              if shFilial EQ '0000' then time16 = 57600.
                              if shFilial EQ '0300' then time16 = 50400.
                              if shFilial EQ '0500' then time16 = 46800.
                              if ((GetXattrValueEx("acct", acct.acct + ',' + acct.currency, "groupOABS", "") EQ '516') or (GetXattrValueEx("acct", acct.acct + ',' + acct.currency, "groupOABS", "") EQ '517')) then time16 = 43200.

                              if history.modif-time <= time16
                                 then 
                                      do:
                                          find first otchet where otchet.acct_cl = op-entry.acct-db no-error.
                                          if avail otchet 
                                             then 
                                                  do: 
                                                      /*message op.op-kind view-as alert-box.*/
                                                      if can-do('*klb*', op.op-kind) then otchet.count_klb_do_16 = otchet.count_klb_do_16 + 1.
                                                      if can-do('*bum*', op.op-kind) then otchet.count_bum_do_16 = otchet.count_bum_do_16 + 1.                                                                                             
                                                  end.
                                             else
                                                  do:
                                                      if can-do('*klb*', op.op-kind)
                                                         then
                                                              do:
                                                                  /*message op.op-kind view-as alert-box.*/
                                                                  nameCl = ''.
                                                                  find first bacct where bacct.acct = op-entry.acct-db no-lock no-error.
                                                                  if avail bacct then RUN GetName (INPUT bacct.cust-cat, INPUT bacct.cust-id, OUTPUT nameCl).
                                                                  create otchet.            
                                                                  assign
                                                                         otchet.first_date      = beg-date
                                                                         otchet.second_date     = end-date
                                                                         otchet.acct_cl         = op-entry.acct-db
                                                                         otchet.name_cl         = nameCl
                                                                         otchet.count_klb_do_16 = 1
                                                                         otchet.count_small     = 0
                                                                         otchet.count_big       = 0
                                                                         otchet.count_both      = 0
                                                                         otchet.count_zagrad_tarif = 0                                                                     
                                                                         otchet.sum1            = 0
                                                                         otchet.sum2            = 0
                                                                         otchet.kom1            = "Нулевая1"
                                                                         otchet.kom2            = "Нулевая1"
                                                                         .
                                                                  release otchet.
                                                              end.
                                                         else
                                                              do:
                                                                  /*message op.op-kind view-as alert-box.*/
                                                                  nameCl = ''.
                                                                  find first bacct where bacct.acct = op-entry.acct-db no-lock no-error.
                                                                  if avail bacct then RUN GetName (INPUT bacct.cust-cat, INPUT bacct.cust-id, OUTPUT nameCl).
                                                                  create otchet.            
                                                                  assign
                                                                         otchet.first_date      = beg-date
                                                                         otchet.second_date     = end-date
                                                                         otchet.acct_cl         = op-entry.acct-db
                                                                         otchet.name_cl         = nameCl
                                                                         otchet.count_bum_do_16 = 1
                                                                         otchet.count_small     = 0
                                                                         otchet.count_big       = 0
                                                                         otchet.count_both      = 0
                                                                         otchet.count_zagrad_tarif = 0
                                                                         otchet.sum1            = 0
                                                                         otchet.sum2            = 0
                                                                         otchet.kom1            = "Нулевая1"
                                                                         otchet.kom2            = "Нулевая1"
                                                                         .
                                                                  release otchet.
                                                              end.
                                                  end.
                                      end.
                                 else 
                                      do:
                                          find first otchet where otchet.acct_cl = op-entry.acct-db no-error.
                                          if avail otchet 
                                             then 
                                                  do: 
                                                      /*message op.op-kind view-as alert-box.*/
                                                      if can-do('*klb*', op.op-kind) then otchet.count_klb_posle_16 = otchet.count_klb_posle_16 + 1.
                                                      if can-do('*bum*', op.op-kind) then otchet.count_bum_posle_16 = otchet.count_bum_posle_16 + 1.                                                                                             
                                                  end.
                                             else
                                                  do:
                                                      if can-do('*klb*', op.op-kind)
                                                         then
                                                              do:
                                                                  /*message op.op-kind view-as alert-box.*/
                                                                  nameCl = ''.
                                                                  find first bacct where bacct.acct = op-entry.acct-db no-lock no-error.
                                                                  if avail bacct then RUN GetName (INPUT bacct.cust-cat, INPUT bacct.cust-id, OUTPUT nameCl).
                                                                  create otchet.            
                                                                  assign
                                                                         otchet.first_date         = beg-date
                                                                         otchet.second_date        = end-date
                                                                         otchet.acct_cl            = op-entry.acct-db
                                                                         otchet.name_cl            = nameCl
                                                                         otchet.count_klb_posle_16 = 1
                                                                         otchet.count_small        = 0
                                                                         otchet.count_big          = 0
                                                                         otchet.count_both         = 0
                                                                         otchet.count_zagrad_tarif = 0
                                                                         otchet.sum1               = 0
                                                                         otchet.sum2               = 0
                                                                         otchet.kom1               = "Нулевая1"
                                                                         otchet.kom2               = "Нулевая1"
                                                                         .
                                                                  release otchet.
                                                              end.
                                                         else
                                                              do:
                                                                  /*message op.op-kind view-as alert-box.*/
                                                                  nameCl = ''.
                                                                  find first bacct where bacct.acct = op-entry.acct-db no-lock no-error.
                                                                  if avail bacct then RUN GetName (INPUT bacct.cust-cat, INPUT bacct.cust-id, OUTPUT nameCl).
                                                                  create otchet.            
                                                                  assign
                                                                         otchet.first_date         = beg-date
                                                                         otchet.second_date        = end-date
                                                                         otchet.acct_cl            = op-entry.acct-db
                                                                         otchet.name_cl            = nameCl
                                                                         otchet.count_bum_posle_16 = 1
                                                                         otchet.count_small        = 0
                                                                         otchet.count_big          = 0
                                                                         otchet.count_both         = 0
                                                                         otchet.count_zagrad_tarif = 0
                                                                         otchet.sum1               = 0
                                                                         otchet.sum2               = 0
                                                                         otchet.kom1               = "Нулевая1"
                                                                         otchet.kom2               = "Нулевая1"
                                                                         .
                                                                  release otchet.
                                                              end.
                                                  end.
                                      end.
                          end.
              end.     
        end.
  end.
/*====================================================================================================================================================================================================================*/



  output stream vvs to value (fname)
          UNBUFFERED  CONVERT  TARGET "UTF-8"  SOURCE "IBM866".
  put stream vvs unformatted 
  '
<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:html="http://www.w3.org/TR/REC-html40">
 <DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
  <Author>Фаворов Евгений Владимирович</Author>
  <LastAuthor>Фаворов Евгений Владимирович</LastAuthor>
  <Created>2016-10-30T10:43:16Z</Created>
  <LastSaved>2016-10-21T05:58:29Z</LastSaved>
  <Version>14.00</Version>
 </DocumentProperties>
 <OfficeDocumentSettings xmlns="urn:schemas-microsoft-com:office:office">
  <AllowPNG/>
  <Colors>
   <Color>
    <Index>14</Index>
    <RGB>#333399</RGB>
   </Color>
   <Color>
    <Index>15</Index>
    <RGB>#333333</RGB>
   </Color>
   <Color>
    <Index>52</Index>
    <RGB>#A9A9A9</RGB>
   </Color>
   <Color>
    <Index>53</Index>
    <RGB>#201F35</RGB>
   </Color>
   <Color>
    <Index>54</Index>
    <RGB>#C0C0C0</RGB>
   </Color>
   <Color>
    <Index>55</Index>
    <RGB>#808080</RGB>
   </Color>
  </Colors>
 </OfficeDocumentSettings>
 <ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">
  <WindowHeight>9855</WindowHeight>
  <WindowWidth>17100</WindowWidth>
  <WindowTopX>480</WindowTopX>
  <WindowTopY>105</WindowTopY>
  <RefModeR1C1/>
  <ProtectStructure>False</ProtectStructure>
  <ProtectWindows>False</ProtectWindows>
 </ExcelWorkbook>
 <Styles>
  <Style ss:ID="Default" ss:Name="Normal">
   <Alignment ss:Vertical="Bottom"/>
   <Borders/>
   <Font ss:FontName="Arial"/>
   <Interior/>
   <NumberFormat/>
   <Protection/>
  </Style>
  <Style ss:ID="m64055936">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font ss:FontName="Tahoma" x:CharSet="204" x:Family="Swiss" ss:Size="12"
    ss:Bold="1"/>
   <Interior ss:Color="#C0C0C0" ss:Pattern="Solid"/>
   <NumberFormat ss:Format="@"/>
   <Protection/>
  </Style>
  <Style ss:ID="m64055956">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font ss:FontName="Tahoma" x:CharSet="204" x:Family="Swiss" ss:Size="12"
    ss:Bold="1"/>
   <Interior ss:Color="#C0C0C0" ss:Pattern="Solid"/>
   <NumberFormat ss:Format="@"/>
   <Protection/>
  </Style>
  <Style ss:ID="m64055976">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font ss:FontName="Arial" x:CharSet="204" x:Family="Swiss" ss:Size="14"
    ss:Bold="1"/>
   <Interior ss:Color="#BFBFBF" ss:Pattern="Solid"/>
  </Style>
  <Style ss:ID="m64056016">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font ss:FontName="Tahoma" x:CharSet="204" x:Family="Swiss" ss:Bold="1"/>
   <Interior ss:Color="#BFBFBF" ss:Pattern="Solid"/>
  </Style>
  <Style ss:ID="s62">
   <Alignment ss:Horizontal="Left" ss:Vertical="Center"/>
  </Style>
  <Style ss:ID="s63">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
  </Style>
  <Style ss:ID="s76">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font ss:FontName="Arial" x:CharSet="204" x:Family="Swiss" ss:Size="14"
    ss:Bold="1"/>
   <Interior ss:Color="#BFBFBF" ss:Pattern="Solid"/>
  </Style>
  <Style ss:ID="s87">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font ss:FontName="Tahoma" x:CharSet="204" x:Family="Swiss" ss:Bold="1"/>
   <Interior ss:Color="#C0C0C0" ss:Pattern="Solid"/>
   <NumberFormat ss:Format="@"/>
   <Protection/>
  </Style>
  <Style ss:ID="s88">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font ss:FontName="Tahoma" x:CharSet="204" x:Family="Swiss" ss:Bold="1"/>
   <Interior ss:Color="#C0C0C0" ss:Pattern="Solid"/>
   <NumberFormat ss:Format="@"/>
   <Protection/>
  </Style>
 </Styles>
 <Worksheet ss:Name="Sheet">
  <Table ss:ExpandedColumnCount="7" ss:ExpandedRowCount="666" x:FullColumns="1"
   x:FullRows="1">
   <Column ss:StyleID="s62" ss:AutoFitWidth="0" ss:Width="160.27"/>
   <Column ss:StyleID="s62" ss:AutoFitWidth="0" ss:Width="287.27"/>
   <Column ss:StyleID="s63" ss:AutoFitWidth="0" ss:Width="66.27" ss:Span="1"/>
   <Column ss:Index="5" ss:AutoFitWidth="0" ss:Width="66.27" ss:Span="1"/>
   <Column ss:Index="7" ss:AutoFitWidth="0" ss:Width="100.27"/>
   <Row ss:AutoFitHeight="0" ss:Height="45">
    <Cell ss:MergeDown="1" ss:StyleID="m64055936"><Data ss:Type="String">СпецСчёт Клиента</Data></Cell>
    <Cell ss:MergeDown="1" ss:StyleID="m64055956"><Data ss:Type="String">Наименование Клиента</Data></Cell>
    <Cell ss:MergeAcross="1" ss:StyleID="m64055976"><Data ss:Type="String">КЛБ</Data></Cell>
    <Cell ss:MergeAcross="1" ss:StyleID="s76"><Data ss:Type="String">БУМ</Data></Cell>
    <Cell ss:MergeDown="1" ss:StyleID="m64056016"><Data ss:Type="String">Количество документов, попадающих под заградительный тариф</Data></Cell>
   </Row>
   <Row ss:AutoFitHeight="0" ss:Height="49.5">
    <Cell ss:Index="3" ss:StyleID="s87"><Data ss:Type="String">Количество документов до 16:00</Data></Cell>
    <Cell ss:StyleID="s87"><Data ss:Type="String">Количество документов после 16:00</Data></Cell>
    <Cell ss:StyleID="s87"><Data ss:Type="String">Количество документов до 16:00</Data></Cell>
    <Cell ss:StyleID="s88"><Data ss:Type="String">Количество документов после 16:00</Data></Cell>
   </Row>
  '.



/*====== заградительный тариф РКО ============================================================================================================================================================================================*/
  for each otchet
  no-lock:
           find first acct where acct.acct = otchet.acct_cl no-error.
           for each op-entry where op-entry.filial-id = shFilial
                               and op-entry.acct-db = acct.acct
                               and can-do('30102*,30110*,30223*,30301*', op-entry.acct-cr)
                               and op-entry.op-date >= beg-date
                               and op-entry.op-date <= end-date
                               and op-entry.op-status begins "√"
           no-lock:
                    /*message "avail op-entry" op-entry.op view-as alert-box.*/
                    find first bop where bop.op = op-entry.op
                                     and bop.op-date >= beg-date
                                     and bop.op-date <= end-date
                                     and can-do('*klb*,*bum*', bop.op-kind)
                                     and can-do('!40101*,!40102*,!40201*,!40204*,!40402*,*', bop.ben-acct)
                                     and can-do('01*', bop.doc-type)
                                     and bop.op-status begins "√"
                                     and bop.filial-id = shfilial
                    no-lock no-error.
                            if avail bop
                            then do:
                                     /*MESSAGE op-entry.acct-db "№" bop.doc-num bop.op op-entry.amt-rub view-as alert-box.*/

                                     /*=============================== Тарифный план Тест-драйв ================================*/
                                     if acct.cust-cat EQ "Ю" 
                                        AND GetXAttrValueEx("cust-corp", string(acct.cust-id), "ТарифныйПлан", "") = "Тест-драйв"
                                        AND can-do('*klb*', bop.op-kind)
                                     then do: 
                                              FIND FIRST tmpsigns WHERE tmpsigns.file-name EQ "cust-corp"
                                                                    AND tmpsigns.surrogate EQ STRING(acct.cust-id)
                                                                    AND tmpsigns.code      EQ "ТарифныйПлан"
                                              NO-LOCK NO-ERROR.
                                                      /*message "Ю" string(bop.op-kind) string(bop.op) view-as alert-box.*/
                                                      IF today <= tmpsigns.since + 90 THEN NEXT.
                                          end.

                                     if acct.cust-cat EQ "Ч"
                                        AND GetXAttrValueEx("person", string(acct.cust-id), "ТарифныйПлан", "") = "Тест-драйв"
                                        AND can-do('*klb*', bop.op-kind)
                                     then do:
                                              FIND FIRST tmpsigns WHERE tmpsigns.file-name EQ "person"
                                                                    AND tmpsigns.surrogate EQ STRING(acct.cust-id)
                                                                    AND tmpsigns.code      EQ "ТарифныйПлан"
                                              NO-LOCK NO-ERROR.
                                                      /*message "Ч" string(op.op-kind) string(bop.op) view-as alert-box.*/
                                                      IF today <= tmpsigns.since + 90 THEN NEXT.
                                          end.
                                     /*========================================== end ==========================================*/                 

                                     /*message string(bop.op-date) " " string(bop.doc-num) " " string(op-entry.amt-rub) string(op-entry.acct-db) string(acct.details) view-as alert-box.*/

/*====================================================================================================================================================================================================================*/
   /*MESSAGE "comgrouprko.p" view-as alert-box.*/

   mSum  = 0.
   mKolDocZagrTarif = 0.
 /*mSum1 = 0.
   mSum2 = 0.
   mKom1 = "Нулевая1".
   mKom2 = "Нулевая1".*/

   IF can-do('01КЛ,01БУМ', bop.doc-type)
      AND op-entry.currency EQ ""
      AND can-do('406*,407*,40807*,40802*', op-entry.acct-db)
      AND can-do('30102*,30110*,30223*,30301*', op-entry.acct-cr)
      AND int(bop.order-pay) > 4
      AND (
           (can-do('!40101*,!40102*,!40201*,!40204*,!40402*,40817*,40820*,423*,426*', bop.ben-acct))
           OR
           (can-do('47422*', bop.ben-acct) AND can-do('*40817*,*408.17*,*40820*,*408.20*,*42301*,*423.01*,*42307*,*423.07*,*42601*,*426.01*', bop.details))
           OR
           (can-do('30232*,47422*', bop.ben-acct) AND can-do('*перечислен*карт*,*перечислен*ПК*,*перевод*карт*,*перевод*ПК*,*зачислен*карт*,*зачислен*ПК*,*пополнен*карт*,*пополнен*ПК*', bop.details))
          )
   THEN DO:
            /*MESSAGE "OK bop AND op-entry" view-as alert-box.*/
            mFlag = 1.
        END.
   ELSE DO:
            /*MESSAGE "NO bop OR op-entry" view-as alert-box.*/
            LEAVE.
        END.



   IF mFlag = 1
   THEN DO:
            FIND FIRST op-bank WHERE op-bank.bank-code-type EQ 'МФО-9'
                                 AND op-bank.op             EQ bop.op
                                 AND can-do('!044525129,!047106641,!045209884,!"",*', op-bank.bank-code)
                                 NO-LOCK NO-ERROR.
                 IF AVAIL op-bank
                 THEN DO: 
                          /*MESSAGE "OK op-bank" view-as alert-box.*/
                          mFlag = 1.
                      END.  
                 ELSE DO:
                          /*MESSAGE "NO op-bank" view-as alert-box.*/
                          LEAVE.
                      END.
        END.



   /*MESSAGE "mFlag =" string(mFlag) view-as alert-box.*/



   /*FIND FIRST acct WHERE acct.acct EQ op-entry.acct-db NO-LOCK NO-ERROR.*/
   /*MESSAGE string(acct.acct) string(acct.cust-cat) string(acct.bal-acct) view-as alert-box.*/

   /*IF can-do('СпБрок,СпецПА,Кон138,КонЗдт,КонРез', acct.contract) THEN LEAVE lMain.*/

   IF acct.cust-cat EQ 'Ч' AND acct.bal-acct EQ 40802 THEN FIND FIRST person WHERE person.person-id EQ acct.cust-id NO-LOCK NO-ERROR.



/*====== ИП платит на свои ФЛ счета ==================================================================================================================================================================================*/
   IF acct.cust-cat EQ 'Ч' 
      AND acct.bal-acct EQ 40802
      AND bop.name-ben EQ string(person.name-last + ' ' + person.first-names)
   THEN DO:
            /*MESSAGE "AVAIL ACCT ИП платит на свои ФЛ счета" view-as alert-box.*/

            FOR EACH bop-entry2 WHERE bop-entry2.filial-id EQ shFilial
                                  AND bop-entry2.acct-db   EQ acct.acct
                                  AND can-do('√,√√,ФБК,ФБН,ФБО,ФБП,ФДД', bop-entry2.op-status)
                                  AND bop-entry2.op-date   >= date('01' + substring(string(today),3)) 
                                  AND bop-entry2.op-date   <= date(today)
                                  AND can-do('30102*,30110*,30223*,30301*', bop-entry2.acct-cr)
                NO-LOCK:
                         /*MESSAGE "AVAIL BOP-ENTRY2" view-as alert-box.*/

                         FIND FIRST bop2 WHERE bop2.op EQ bop-entry2.op NO-LOCK NO-ERROR.
                         IF AVAIL bop2 
                              AND can-do('01КЛ,01БУМ', bop2.doc-type)
                              AND (
                                   (can-do('!40101*,!40102*,!40201*,!40204*,!40402*,40817*,40820*,423*,426*', bop2.ben-acct))
                                   OR
                                   (can-do('47422*', bop2.ben-acct) AND can-do('*40817*,*408.17*,*40820*,*408.20*,*42301*,*423.01*,*42307*,*423.07*,*42601*,*426.01*', bop2.details))
                                   OR
                                   (can-do('30232*,47422*', bop2.ben-acct) AND can-do('*перечислен*карт*,*перечислен*ПК*,*перевод*карт*,*перевод*ПК*,*зачислен*карт*,*зачислен*ПК*,*пополнен*карт*,*пополнен*ПК*', bop2.details))
                                  )
                              AND int(bop2.order-pay) > 4
                              AND bop2.name-ben EQ string(person.name-last + ' ' + person.first-names)
                         THEN DO:
                                  /*MESSAGE "AVAIL BOP2" view-as alert-box.*/

                                  FIND FIRST op-bank WHERE op-bank.op EQ bop-entry2.op 
                                                       AND op-bank.bank-code-type EQ 'МФО-9'
                                                       AND can-do('!044525129,!047106641,!045209884,!"",*', op-bank.bank-code)                        
                                       NO-LOCK NO-ERROR.
                                  IF AVAIL op-bank THEN DO:
                                                            /*MESSAGE "AVAIL OP-BANK" view-as alert-box.*/

	     	                                            IF bop-entry2.currency EQ acct.currency
                                                               AND bop-entry2.currency EQ '' 
                                                               AND bop-entry2.amt-rub > 0
                                                            THEN DO:
                                                                     IF mSum + bop-entry2.amt-rub <= 350000 THEN DO: 
                                                                                                                   /*mKom1 = "RkoIpSmall".
                                                                                                                     mSum1 = op-entry.amt-rub.
                                                                                                                     mKom2 = "Нулевая1".
                                                                                                                     mSum2 = 0.*/

                                                                                                                     nameCl = ''.
                                                                                                                     otchet.count_small = otchet.count_small + 1.
                                                                                                                     otchet.sum1        = otchet.sum1 + bop-entry2.amt-rub.
                                                                                                                     otchet.sum2        = otchet.sum2 + 0.
                                                                                                                     otchet.kom1        = "RkoIpSmall".
                                                                                                                     otchet.kom2        = "Нулевая1".
                                                                                                                 END.
                                                                     IF ((mSum < 350000) AND (mSum + bop-entry2.amt-rub > 350000)) THEN DO: 
                                                                                                                                          /*mKom1 = "RkoIpSmall".
                                                                                                                                            mSum1 = 350000 - mSum.
                                                                                                                                            mKom2 = "RkoIpMiddle".
                                                                                                                                            mSum2 = op-entry.amt-rub - mSum1.*/

                                                                                                                                            nameCl = ''.
                                                                                                                                            otchet.count_both = otchet.count_both + 1.
                                                                                                                                            otchet.sum1       = otchet.sum1 + 350000 - mSum.
                                                                                                                                            otchet.sum2       = otchet.sum2 + bop-entry2.amt-rub - 350000 + mSum.
                                                                                                                                            otchet.kom1       = "RkoIpSmall".
                                                                                                                                            otchet.kom2       = "RkoIpMiddle".
                                                                                                                                        END.
                                                                     IF ((mSum >= 350000) OR (bop-entry2.amt-rub > 350000)) THEN DO: 
                                                                                                                                   /*mKom1 = "Нулевая1".
                                                                                                                                     mSum1 = 0.
                                                                                                                                     mKom2 = "RkoIpMiddle".
                                                                                                                                     mSum2 = op-entry.amt-rub.*/

                                                                                                                                     nameCl = ''.
                                                                                                                                     otchet.count_big = otchet.count_big + 1.
                                                                                                                                     otchet.sum1      = otchet.sum1 + 0.
                                                                                                                                     otchet.sum2      = otchet.sum2 + bop-entry2.amt-rub.
                                                                                                                                     otchet.kom1      = "Нулевая1".
                                                                                                                                     otchet.kom2      = "RkoIpBig".
                                                                                                                                 END.
                                                                     mSum = mSum + bop-entry2.amt-rub.
                                                                     otchet.count_zagrad_tarif = otchet.count_zagrad_tarif + 1.
                                                                     /*MESSAGE string(mSum) view-as alert-box.*/
                                                                 END.
                          	     	                    
                                                            /*IF bop-entry2.currency EQ acct.currency
                                                                 AND bop-entry2.currency NE ''
                                                                 AND bop-entry2.amt-cur > 0
                                                              THEN DO:
                                                                       mSum = mSum + bop-entry2.amt-cur.
                                                                       /*MESSAGE string(mSum) view-as alert-box.*/
                                                                   END.*/
                                                        END.
                              END.
                         ELSE NEXT.
            END.

            /*IF op-entry.currency EQ acct.currency
               AND op-entry.currency EQ '' 
               AND op-entry.amt-rub > 0
            THEN DO:
                     mSum = mSum + op-entry.amt-rub.
                     /*MESSAGE string(mSum) view-as alert-box.*/
                 END.*/
                          	     	                    
            /*IF op-entry.currency EQ acct.currency
               AND op-entry.currency NE ''
               AND op-entry.amt-cur > 0
            THEN DO:
                     mSum = mSum + op-entry.amt-cur.
                     /*MESSAGE string(mSum) view-as alert-box.*/
                 END.*/
            /*
            IF mSum + op-entry.amt-rub <= 350000 THEN DO: 
                                                          mKom1 = "RkoIpSmall".
                                                          mSum1 = op-entry.amt-rub.
                                                          mKom2 = "Нулевая1".
                                                          mSum2 = 0.
                                                      END.
            IF ((mSum < 350000) AND (mSum + op-entry.amt-rub > 350000)) THEN DO: 
                                                                                 mKom1 = "RkoIpSmall".
                                                                                 mSum1 = 350000 - mSum.
                                                                                 mKom2 = "RkoIpMiddle".
                                                                                 mSum2 = op-entry.amt-rub - mSum1.
                                                                             END.
            IF ((mSum >= 350000) OR (op-entry.amt-rub > 350000)) THEN DO: 
                                                                          mKom1 = "Нулевая1".
                                                                          mSum1 = 0.
                                                                          mKom2 = "RkoIpMiddle".
                                                                          mSum2 = op-entry.amt-rub.
                                                                      END.
            */
        END. /* ИП платит на свои ФЛ счета */



/*====== ИП платит на чужие ФЛ счета =================================================================================================================================================================================*/
   IF acct.cust-cat EQ 'Ч' 
      AND acct.bal-acct EQ 40802
      AND bop.name-ben NE string(person.name-last + ' ' + person.first-names)
   THEN DO:
            /*MESSAGE "AVAIL ACCT ИП платит на чужие ФЛ счета" view-as alert-box.*/

            /*FOR EACH bop-entry2 WHERE bop-entry2.filial-id EQ shFilial
                                  AND bop-entry2.acct-db   EQ acct.acct
                                  AND can-do('√,√√,ФБК,ФБН,ФБО,ФБП,ФДД', bop-entry2.op-status)
                                  AND bop-entry2.op-date   >= date('01' + substring(string(today),3)) 
                                  AND bop-entry2.op-date   <= date(today)
                                  AND can-do('30102*,30110*,30223*,30301*', bop-entry2.acct-cr)
                NO-LOCK:
                         /*MESSAGE "AVAIL BOP-ENTRY2" view-as alert-box.*/

                         FIND FIRST bop2 WHERE bop2.op EQ bop-entry2.op NO-LOCK NO-ERROR.
                         IF AVAIL bop2 
                              AND can-do('01КЛ,01БУМ', bop2.doc-type)
                              AND can-do('!40101*,!40102*,!40201*,!40204*,!40402*,40817*,40820*,423*,426*', bop2.ben-acct)
                              AND int(bop2.order-pay) > 4
                              AND bop2.name-ben NE string(person.name-last + ' ' + person.first-names)
                         THEN DO:
                                  /*MESSAGE "AVAIL BOP2" view-as alert-box.*/

                                  FIND FIRST op-bank WHERE op-bank.op EQ bop-entry2.op 
                                                       AND op-bank.bank-code-type EQ 'МФО-9'
                                                       AND can-do('!044525129,!047106641,!045209884,!"",*', op-bank.bank-code)                        
                                       NO-LOCK NO-ERROR.
                                  IF AVAIL op-bank THEN DO:
                                                            /*MESSAGE "AVAIL OP-BANK" view-as alert-box.*/

	     	                                            IF bop-entry2.currency EQ acct.currency
                                                               AND bop-entry2.currency EQ '' 
                                                               AND bop-entry2.amt-rub > 0
                                                            THEN DO:
                                                                   /*mKom1 = "RkoIpBig".
                                                                     mSum1 = op-entry.amt-rub.
                                                                     mKom2 = "Нулевая1".
                                                                     mSum2 = 0.*/

                                                                     nameCl = ''.
                                                                     otchet.count_big = otchet.count_big + 1.
                                                                     otchet.sum1      = otchet.sum1 + bop-entry2.amt-rub.
                                                                     otchet.sum2      = otchet.sum2 + 0.
                                                                     otchet.kom1      = "RkoIpBig".
                                                                     otchet.kom2      = "Нулевая1".
                                                                     mSum = mSum + bop-entry2.amt-rub.
                                                                     otchet.count_zagrad_tarif = otchet.count_zagrad_tarif + 1.
                                                                     /*MESSAGE string(mSum) view-as alert-box.*/
                                                                 END.
                          	     	                    
                                                            /*IF bop-entry2.currency EQ acct.currency
                                                                 AND bop-entry2.currency NE ''
                                                                 AND bop-entry2.amt-cur > 0
                                                              THEN DO:
                                                                       mSum = mSum + bop-entry2.amt-cur.
                                                                       /*MESSAGE string(mSum) view-as alert-box.*/
                                                                   END.*/
                                                        END.
                              END.
                         ELSE NEXT.
            END.*/

            /*IF op-entry.currency EQ acct.currency
               AND op-entry.currency EQ '' 
               AND op-entry.amt-rub > 0
            THEN DO:
                     mSum = mSum + op-entry.amt-rub.
                     /*MESSAGE string(mSum) view-as alert-box.*/
                 END.*/
                          	     	                    
            /*IF op-entry.currency EQ acct.currency
               AND op-entry.currency NE ''
               AND op-entry.amt-cur > 0
            THEN DO:
                     mSum = mSum + op-entry.amt-cur.
                     /*MESSAGE string(mSum) view-as alert-box.*/
                 END.*/
            /*
            mKom1 = "RkoIpBig".
            mSum1 = op-entry.amt-rub.
            mKom2 = "Нулевая1".
            mSum2 = 0.
            */
        END. /* ИП платит на чужие ФЛ счета */



/*====== ЮЛ платит на счета ФЛ =======================================================================================================================================================================================*/
   IF acct.cust-cat EQ 'Ю'
      AND can-do('406*,407*,40807*', acct.acct)
      AND can-do('!*дивиденд*,!*дивид-*,*', bop.details)

   THEN DO:
            /*MESSAGE "AVAIL ACCT ЮЛ платит на счета ФЛ" view-as alert-box.*/

            FOR EACH bop-entry2 WHERE bop-entry2.filial-id EQ shFilial
                                  AND bop-entry2.acct-db   EQ acct.acct
                                  AND can-do('√,√√,ФБК,ФБН,ФБО,ФБП,ФДД', bop-entry2.op-status)
                                  AND bop-entry2.op-date   >= date('01' + substring(string(today),3)) 
                                  AND bop-entry2.op-date   <= date(today)
                                  AND can-do('30102*,30110*,30223*,30301*', bop-entry2.acct-cr)
                NO-LOCK:
                         /*MESSAGE "AVAIL BOP-ENTRY2" bop-entry2.op view-as alert-box.*/

                         FIND FIRST bop2 WHERE bop2.op EQ bop-entry2.op NO-LOCK NO-ERROR.
                         IF AVAIL bop2 
                              AND can-do('01КЛ,01БУМ', bop2.doc-type)
                              AND (
                                   (can-do('!40101*,!40102*,!40201*,!40204*,!40402*,40817*,40820*,423*,426*', bop2.ben-acct))
                                   OR
                                   (can-do('47422*', bop2.ben-acct) AND can-do('*40817*,*408.17*,*40820*,*408.20*,*42301*,*423.01*,*42307*,*423.07*,*42601*,*426.01*', bop2.details))
                                   OR
                                   (can-do('30232*,47422*', bop2.ben-acct) AND can-do('*перечислен*карт*,*перечислен*ПК*,*перевод*карт*,*перевод*ПК*,*зачислен*карт*,*зачислен*ПК*,*пополнен*карт*,*пополнен*ПК*', bop2.details))
                                  )
                              AND can-do('!*дивиденд*,!*дивид-*,*', bop2.details)
                              AND int(bop2.order-pay) > 4
                         THEN DO:
                                  /*MESSAGE "AVAIL BOP2" bop-entry2.op view-as alert-box.*/

                                  FIND FIRST op-bank WHERE op-bank.op EQ bop-entry2.op 
                                                       AND op-bank.bank-code-type EQ 'МФО-9'
                                                       AND can-do('!044525129,!047106641,!045209884,!"",*', op-bank.bank-code)                        
                                       NO-LOCK NO-ERROR.
                                  IF AVAIL op-bank THEN DO:
                                                            /*MESSAGE "AVAIL OP-BANK" bop-entry2.op view-as alert-box.*/

	     	                                            IF bop-entry2.currency EQ acct.currency
                                                               AND bop-entry2.currency EQ '' 
                                                               AND bop-entry2.amt-rub > 0
                                                            THEN DO:
                                                                     IF mSum + bop-entry2.amt-rub <= 150000 THEN DO: 
                                                                                                                   /*message acct.acct bop2.op bop-entry2.amt-rub "small" view-as alert-box.*/

                                                                                                                   /*mKom1 = "RkoYlSmall".
                                                                                                                     mSum1 = op-entry.amt-rub.
                                                                                                                     mKom2 = "Нулевая1".
                                                                                                                     mSum2 = 0.*/

                                                                                                                     nameCl = ''.
                                                                                                                     otchet.count_small = otchet.count_small + 1.
                                                                                                                     otchet.sum1        = otchet.sum1 + bop-entry2.amt-rub.
                                                                                                                     otchet.sum2        = otchet.sum2 + 0.
                                                                                                                     otchet.kom1        = "RkoYlSmall".
                                                                                                                     otchet.kom2        = "Нулевая1".
                                                                                                                 END.
                                                                     IF ((mSum < 150000) AND (mSum + bop-entry2.amt-rub > 150000)) THEN DO: 
                                                                                                                                          /*message acct.acct bop2.op bop-entry2.amt-rub "both" view-as alert-box.*/

                                                                                                                                          /*mKom1 = "RkoYlSmall".
                                                                                                                                            mSum1 = 150000 - mSum.
                                                                                                                                            mKom2 = "RkoYlBig".
                                                                                                                                            mSum2 = op-entry.amt-rub - mSum1.*/

                                                                                                                                            nameCl = ''.
                                                                                                                                            otchet.count_both = otchet.count_both + 1.
                                                                                                                                            otchet.sum1       = otchet.sum1 + 150000 - mSum.
                                                                                                                                            otchet.sum2       = otchet.sum2 + bop-entry2.amt-rub - 150000 + mSum.
                                                                                                                                            otchet.kom1       = "RkoYlSmall".
                                                                                                                                            otchet.kom2       = "RkoYlBig".
                                                                                                                                        END.
                                                                     IF ((mSum >= 150000) OR (bop-entry2.amt-rub > 150000)) THEN DO: 
                                                                                                                                   /*message acct.acct bop2.op bop-entry2.amt-rub "big" view-as alert-box.*/

                                                                                                                                   /*mKom1 = "Нулевая1".
                                                                                                                                     mSum1 = 0.                                                                                       
                                                                                                                                     mKom2 = "RkoYlBig".
                                                                                                                                     mSum2 = op-entry.amt-rub.*/

                                                                                                                                     nameCl = ''.
                                                                                                                                     otchet.count_big = otchet.count_big + 1.
                                                                                                                                     otchet.sum1      = otchet.sum1 + 0.
                                                                                                                                     otchet.sum2      = otchet.sum2 + bop-entry2.amt-rub.
                                                                                                                                     otchet.kom1      = "Нулевая1".
                                                                                                                                     otchet.kom2      = "RkoYlBig".
                                                                                                                                 END.
                                                                     mSum = mSum + bop-entry2.amt-rub.
                                                                     otchet.count_zagrad_tarif = otchet.count_zagrad_tarif + 1.
                                                                     /*MESSAGE string(mSum) view-as alert-box.*/
                                                                 END.
                          	     	                    
                                                            /*IF bop-entry2.currency EQ acct.currency
                                                                 AND bop-entry2.currency NE ''
                                                                 AND bop-entry2.amt-cur > 0
                                                              THEN DO:
                                                                       mSum = mSum + bop-entry2.amt-cur.
                                                                       /*MESSAGE string(mSum) view-as alert-box.*/
                                                                   END.*/
                                                        END.
                              END.
                         ELSE NEXT.
            END.

            /*IF op-entry.currency EQ acct.currency
                 AND op-entry.currency EQ '' 
                 AND op-entry.amt-rub > 0
              THEN DO:
                       mSum = mSum + op-entry.amt-rub.
                       /*MESSAGE string(mSum) view-as alert-box.*/
                   END.*/
                          	     	                    
            /*IF op-entry.currency EQ acct.currency
                 AND op-entry.currency NE ''
                 AND op-entry.amt-cur > 0
              THEN DO:
                       mSum = mSum + op-entry.amt-cur.
                       /*MESSAGE string(mSum) view-as alert-box.*/
                   END.*/
            /*
            IF mSum + op-entry.amt-rub <= 150000 THEN DO: 
                                                          mKom1 = "RkoYlSmall".
                                                          mSum1 = op-entry.amt-rub.
                                                          mKom2 = "Нулевая1".
                                                          mSum2 = 0.
                                                      END.
            IF ((mSum < 150000) AND (mSum + op-entry.amt-rub > 150000)) THEN DO: 
                                                                                 mKom1 = "RkoYlSmall".
                                                                                 mSum1 = 150000 - mSum.
                                                                                 mKom2 = "RkoYlBig".
                                                                                 mSum2 = op-entry.amt-rub - mSum1.
                                                                             END.
            IF ((mSum >= 150000) OR (op-entry.amt-rub > 150000)) THEN DO: 
                                                                         mKom1 = "Нулевая1".
                                                                         mSum1 = 0.
                                                                         mKom2 = "RkoYlBig".
                                                                         mSum2 = op-entry.amt-rub.
                                                                     END.
            */
        END. /* ЮЛ платит на счета ФЛ */

   /*
   IF     mKom1 = "Нулевая1"
      AND mKom2 = "Нулевая1" 
      AND mSum1 = 0 
      AND mSum2 = 0
   THEN DO:
         oResult = YES.
         {intrface.del}
         RETURN.
        END.
   */

   end. /* if avail bop */

   /*MESSAGE string(op.op) string(op.op-transaction) chr(10) string(substr(op-entry.acct-db, 1, 20)) chr(10) string(mSum) chr(10) string(mSum1) string(mKom1) chr(10) string(mSum2) string(mKom2) view-as alert-box.*/
   /*MESSAGE string(substr(op-entry.acct-db, 1, 20)) chr(10) string(mSum) chr(10) string(mSum1) string(mKom1) chr(10) string(mSum2) string(mKom2) view-as alert-box.*/
   /*
   RUN SetSysConf in h_base ("mOp",            op.op).
   RUN SetSysConf in h_base ("mOpTransaction", op.op-transaction).
   RUN SetSysConf in h_base ("mAcctCl",        op-entry.acct-db).
   RUN SetSysConf in h_base ("mDetails",       op.details).
   RUN SetSysConf in h_base ("mSum1",          mSum1).
   RUN SetSysConf in h_base ("mSum2",          mSum2).
   RUN SetSysConf in h_base ("mKom1",          mKom1).
   RUN SetSysConf in h_base ("mKom2",          mKom2).
   */
/*====================================================================================================================================================================================================================*/
           end. /* for each */
  end. /* for each */
/*====================================================================================================================================================================================================================*/


 
 FOR EACH otchet NO-LOCK:
     /*
       FIELD first_date         AS DATE                /* первая дата */
       FIELD second_date        AS DATE                /* вторая дата */
       FIELD acct_cl            AS CHAR                /* счёт клиента */
       FIELD name_cl            AS CHAR                /* наименование клиента */
       FIELD count_klb_do_16    AS INT64               /* количество КЛБ проводок до 16:00 */
       FIELD count_bum_do_16    AS INT64               /* количество БУМ проводок до 16:00 */
       FIELD count_klb_posle_16 AS INT64               /* количество КЛБ проводок после 16:00 */
       FIELD count_bum_posle_16 AS INT64               /* количество БУМ проводок после 16:00 */
       FIELD count_small        AS INT64
       FIELD count_big          AS INT64
       FIELD count_both         AS INT64
       FIELD count_zagrad_tarif AS INT64
       FIELD sum1               AS DEC
       FIELD sum2               AS DEC
       INDEX acct_cl acct_cl       
     */

     /*MESSAGE otchet.first_date otchet.second_date otchet.acct_cl otchet.name_cl otchet.count_klb_do_16 otchet.count_klb_posle_16 otchet.count_bum_do_16 otchet.count_bum_posle_16 otchet.count_small otchet.count_big otchet.count_both view-as alert-box.*/

     put stream vvs unformatted
     '<Row ss:AutoFitHeight="0">'.

     IF otchet.first_date EQ ? THEN put stream vvs unformatted '<Cell ss:StyleID="s63"><Data ss:Type="String"></Data></Cell>\n'.
     put stream vvs unformatted '<Cell ss:StyleID="s63"><Data ss:Type="String">'.
     put stream vvs unformatted otchet.acct_cl + '</Data></Cell>\n'.
     put stream vvs unformatted '<Cell><Data ss:Type="String">'.
     put stream vvs unformatted otchet.name_cl + '</Data></Cell>\n'.
     put stream vvs unformatted '<Cell ss:StyleID="s63"><Data ss:Type="String">'.
     put stream vvs unformatted trim(string(otchet.count_klb_do_16,"->>>>>>>>>9")) + '</Data></Cell>\n'.
     put stream vvs unformatted '<Cell ss:StyleID="s63"><Data ss:Type="String">'.
     put stream vvs unformatted trim(string(otchet.count_klb_posle_16,"->>>>>>>>>9")) + '</Data></Cell>\n'.
     put stream vvs unformatted '<Cell ss:StyleID="s63"><Data ss:Type="String">'.
     put stream vvs unformatted trim(string(otchet.count_bum_do_16,"->>>>>>>>>9")) + '</Data></Cell>\n'.
     put stream vvs unformatted '<Cell ss:StyleID="s63"><Data ss:Type="String">'.
     put stream vvs unformatted trim(string(otchet.count_bum_posle_16,"->>>>>>>>>9")) + '</Data></Cell>\n'.
     put stream vvs unformatted '<Cell ss:StyleID="s63"><Data ss:Type="String">'.
     put stream vvs unformatted trim(string(otchet.count_zagrad_tarif,"->>>>>>>>>9")) + '</Data></Cell>\n'.
     put stream vvs unformatted '</Row>'.
 END. /* FOR EACH otchet NO-LOCK: */

  put stream vvs unformatted 
  '  </Table>
   </Worksheet>
  </Workbook>
  ' .

  output stream vvs close.
  RUN sndbispc ("file=" + fname + ";class=bq").

END.



IF iForm = 'YES' THEN DO: 
  /*объявляем handle для передачи temp-table в УТ*/
  DEF NEW SHARED VAR hO-tt  AS HANDLE NO-UNDO.
  DEF VAR            hO-b   AS HANDLE NO-UNDO.
  DEF VAR            hO-btt AS HANDLE NO-UNDO.

  /*заполняем таблицу для УТ*/
  hO-b = BUFFER otchet:HANDLE.

  CREATE TEMP-TABLE hO-tt.
  hO-tt:CREATE-LIKE("otchet").
  hO-tt:TEMP-TABLE-PREPARE("xotchet").
  
  hO-btt = hO-tt:DEFAULT-BUFFER-HANDLE.

  FOR EACH otchet:
    hO-btt:BUFFER-CREATE.
    hO-btt:BUFFER-COPY(hO-b).
  END.
    RETURN STRING(hO-tt).
END.
/*удаляем шаред*/
IF iForm = 'NO' THEN DELETE OBJECT hO-tt.



PROCEDURE GetName:
 DEF INPUT PARAMETER cat AS CHARACTER.
 DEF INPUT PARAMETER id AS INT64.
 DEF OUTPUT PARAMETER sname AS CHARACTER.
 
 IF cat = "Ч" THEN
  DO:
   FIND FIRST PERSON 
   WHERE PERSON.PERSON-ID = id
   NO-LOCK NO-ERROR.
    IF AVAIL PERSON THEN
    /* ФИО клиента */
    sname = "ИП " + PERSON.NAME-LAST + " " + PERSON.FIRST-NAMES.
  END.
 ELSE
  DO:
   FIND FIRST CUST-CORP 
   WHERE CUST-CORP.CUST-ID = id
   NO-LOCK NO-ERROR.
    IF AVAIL CUST-CORP THEN
    /* наименование организации */
    sname = CUST-CORP.CUST-STAT + " " + CUST-CORP.NAME-CORP.
  END.
END. 
