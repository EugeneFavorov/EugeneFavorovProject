
/*
                Банковская интегрированная система БИСквит
    Copyright:  (C) 1992-2000 ТОО "Банковские информационные системы"
     Filename:  imp-opcr.mci
      Comment:  Создание документов при импорте из МЦИ
         Uses:  op(sess).cr imp-opcr.sgn op-code.ass op.i position.i
      Used by:  imp-mcip.p

      Created:  19/02/1999 10:58 Mike
       Modify:  25/01/2000 15:40 Mike
                для ответных
                - дата валютирования = дате опредня
                - дата дкумент от  = дате опердня, если ее нeт в файле
                - user = userid, запустившего импорт.
*/
/* def buffer buf-code for code no-undo. */


for each w-op:
   mem-op = w-op.op.
   create op.
   cur-op-trans = ?.
   output to "./zperr.bak".
   {op(sess).cr}
   output close.
   assign
     w-op.op = op.op
     w-op.op-trans = op.op-trans.
   {op.i &buf1=op &buf2=w-op}
/*
   find first buf-code where buf-code.class = "ВидОпер" and
                             buf-code.code eq  w-op.doc-type
                             no-lock no-error.
                             */
   w-op.op = mem-op.
   find first w-op-entry where w-op-entry.op eq w-op.op no-error.
   ASSIGN
      op.op-tran     = cur-op-trans
      op.class-code  = if op-templ.cr-class-code ne "" and
                          op-templ.cr-class-code ne ? then
                          op-templ.cr-class-code
                       else "opb"
      op.op-date        = in-op-date
      op.op-value-date  = in-op-date
      op.due-date       = if op.due-date eq ? then in-op-date else op.due-date
      op.acct-cat = (if flag-go = 121 then w-op.acct-cat else "b")
      op.ben-acct = if flag-go eq 1 then w-op.acct-send else w-op.acct-rec
      op.name-ben = if flag-go eq 1 then w-op.name-send else w-op.name-rec
      op.inn      = w-op.inn
      op.op-kind  = op-kind.op-kind

      op.doc-type = w-op.doc-type

      op.op-templ = 1
      op.details  = w-op.details
      /*op.op-status = if flag-reestr then status-end else status-noend*/
      vFlagDB      = NO
      vFlagCR      = NO
    .
      op.user-id   = userid('bisquit').

    /*   op.user-inspector = userid("bisquit"). */

/*message "7 op.op-date=" string (op.op-date) "op.op-status=" op.op-status view-as alert-box.*/

      IF FGetSetting("МЦИ","ПланДатаОперДень","") EQ "Да" THEN
         op.contract-date  = in-op-date.

      vIsIntr =     bank-mfo-9         EQ w-op.bank-code-rec
               AND  w-op.bank-code-rec EQ w-op.bank-code-send
               AND {assigned w-op.acct-rec}.

                   /* Полноформатные ответные документы */

/*message "7 w-op-entry.acct-db=" w-op-entry.acct-db view-as alert-box.*/
/* message w-op-entry.acct-db + ' dd ' + w-op-entry.acct-cr view-as alert-box. */
   /* ASSIGN
      w-op-entry.acct-db = CheckAcctClose(w-op-entry.acct-db,nacct-cr).
      w-op-entry.acct-cr = CheckAcctClose(w-op-entry.acct-cr,nacct-db).
      */
/*message "8 w-op-entry.acct-db=" w-op-entry.acct-db view-as alert-box.*/


   &IF DEFINED(ORACLE) &THEN
      RUN saverec.p ((BUFFER op:HANDLE)).
   &ENDIF

   RUN cr-op-entry.
/*
if not avail op then do:
    
    message 'not found op!' view-as alert-box.
    end.
  */  
   FIND FIRST  op-entry  OF op  EXCLUSIVE-LOCK NO-ERROR.
   /*
if not avail op-entry then do:
    
    message 'not found op-entry (zp.mci)' view-as alert-box.
    end.
    */
         create op-bank.
         assign
            op-bank.op             = op.op
            op-bank.op-bank-type   = ""
            op-bank.bank-code-type = "МФО-9"
            op-bank.bank-code      = /*if flag-go eq 1
                                     then w-op.bank-code-send
                                     else*/ w-op.bank-code-rec
            op-bank.corr-acct      = /*if flag-go eq 1
                                     then  w-op.bank-corr-acct-send
                                     else */ w-op.bank-corr-acct-rec
	    /*op-bank.bank-name = w-op-bank.bank-name*/
	    op.ben-acct = w-op.ben-acct
	    op.name-ben = w-op.name-ben

            op.doc-kind = "rec".

/*message "nimp op-bank.bank-code=" op-bank.bank-code view-as alert-box.*/
/*message "nimp op.ben-acct=" op.ben-acct "w-op.ben-acct=" w-op.ben-acct view-as alert-box.*/


   for each w-signs where w-signs.file = "op"
                      and w-signs.surr = string(w-op.op)
                          no-lock:
      mVal = if w-signs.code-val ne "" then w-signs.code-val
                                       else w-signs.xattr-val.

      UpdateSigns('op',
                  string(op.op),
                  w-signs.code,
                  mVal,
                  isXAttrIndexed(op.class-code,w-signs.code)).
   end.

   mem-op = op.op.

   find current op         no-lock no-error.
   find current op-entry   no-lock no-error.
   find current op-bank    no-lock no-error.
   find current op-impexp  no-lock no-error.

end.  /* for each w-op */

RUN i-del-wr.
