/*
   реестры 136-И за период для проверяющих ЦБ

               Банковская интегрированная система БИСквит
    Copyright: (C) 1992-2010 ЗАО "Банковские информационные системы"
     Filename: RST-136I.P
      Comment: <comment>
   Parameters:
         Uses:
      Used by:
      Created: 19.10.2010 16:22 elus    
     Modified: 19.10.2010 16:22 elus    
*/

DEFINE INPUT  PARAMETER iParam AS CHARACTER   NO-UNDO.
{globals.i}     /* Здесь почти все */
{wordwrap.def}
{intrface.get cust}  
{intrface.get xclass}

FUNCTION GetPassport  CHAR (INT64) FORWARD.
FUNCTION CutFio       CHAR (CHARACTER) FORWARD.

DEFINE VARIABLE mLines     AS CHARACTER   NO-UNDO EXTENT 30. /* Табличка */
DEFINE VARIABLE mCols      AS INT64       NO-UNDO. /* Ширина отчета */

DEFINE VARIABLE mIsCheckBuy AS LOGICAL   NO-UNDO. /* Yes - ежели чеков купили */
DEFINE VARIABLE mIsCheckSel AS LOGICAL   NO-UNDO. /* Yes - ежели чеков продали */
DEFINE VARIABLE mLogComm    AS LOGICAL   NO-UNDO. /* Реестр с комиссиями */
DEFINE VARIABLE mStatus     AS CHARACTER NO-UNDO. /* Статус документов попадающих в реестр */
DEFINE VARIABLE mSpace      AS CHARACTER NO-UNDO.
/* DEFINE VARIABLE mFullItg  AS LOGICAL NO-UNDO.*/

DEFINE TEMP-TABLE ttRegister
   FIELD op       AS INTEGER   /* id документа          */
   FIELD doc-num  AS CHARACTER /* Номер документа       */
   FIELD doc-time AS INTEGER   /* Время операции        */
   FIELD doc-date AS DATE      /* Дата создания докум   */
   FIELD doc-kind AS CHARACTER /* ВидОпНалВ             */
   FIELD rate     AS DECIMAL   /* Курс                  */
   FIELD ChRate   AS CHARACTER
   FIELD curr-db  AS CHARACTER /* Валюта принято        */
   FIELD amt-db   AS DECIMAL   /* Сумма принято         */
   FIELD curr-cr  AS CHARACTER /* Валюта выдано         */
   FIELD amt-cr   AS DECIMAL   /* Сумма выдано          */
   FIELD card     AS LOGICAL   /* Признак операции с пк */
   FIELD cheq-qty AS DECIMAL   /* Колво чеков           */
   FIELD currcheq AS CHARACTER /* Валюта чеков          */
   FIELD amt-cheq AS DECIMAL   /* Сумма чеков           */
   FIELD acct     AS CHARACTER /* Счет физ. лица        */
   FIELD dover    AS LOGICAL   /* Доверенность          */
   FIELD country  AS CHARACTER /* Код страны ф.л.       */
   FIELD dpr-id   AS INTEGER     /* id смены документа    */
   FIELD forminfo AS CHARACTER /* Информация по чекам на будующее  */
   FIELD vain     AS LOGICAL   /* Пустой */

   INDEX idx dpr-id doc-date doc-time
   .

DEFINE TEMP-TABLE ttRegItog
   FIELD doc-date AS DATE      /* Дата реестра          */
   FIELD doc-kind AS CHARACTER /* ВидОпНалВ             */
   FIELD ChRate   AS CHARACTER
   FIELD curr-db  AS CHARACTER /* Валюта принято        */
   FIELD amt-db   AS DECIMAL   /* Сумма принято         */
   FIELD curr-cr  AS CHARACTER /* Валюта выдано         */
   FIELD amt-cr   AS DECIMAL   /* Сумма выдано          */
   FIELD cheq-qty AS DECIMAL   /* Колво чеков           */
   FIELD currcheq AS CHARACTER /* Валюта чеков          */
   FIELD amt-cheq AS DECIMAL   /* Сумма чеков           */
   FIELD Summa    AS DECIMAL  /* Сумма комиссий        */
	
   INDEX idx doc-date doc-kind curr-db curr-cr currcheq
   .

DEFINE TEMP-TABLE ttReg-Det NO-UNDO

   FIELD Op        AS INTEGER      LABEL "Номер операции"
   FIELD doc-kind AS CHARACTER  LABEL "Вид операции"
   FIELD Currency  AS CHARACTER  LABEL "Код валюты"         
   FIELD SummSign  AS CHARACTER  LABEL "Признак суммы"
   FIELD Summa     AS DECIMAL    LABEL "Сумма "             
   FIELD SummaR    AS DECIMAL    LABEL "Рублевый эквивалент"

   INDEX idx Op Currency SummSign
   .

beg-date = today - 1.
end-date = today - 1.
{getdates.i &noinit = YES}

{setdest.i}

ASSIGN
   mLogComm = ENTRY(1,iParam,";") EQ "Комиссии"
   mStatus  = ENTRY(2,iParam,";") WHEN NUM-ENTRIES(iParam,";") > 1 
   mSpace   = FILL(" ",INT(ENTRY(3,iParam,";"))) WHEN NUM-ENTRIES(iParam,";") > 2
   mStatus  = CHR(251) WHEN NOT CAN-FIND(FIRST code WHERE 
                                               code.class  EQ "Статус"
                                           AND code.code   EQ mStatus)
   .
ASSIGN
   mLines[ 1] = "┌────────┬────────┬────┬───────┬─────────────────────────────────────────┬────┬───────────────────────────┬────────────────────┬─────┬─────┬────────────────────┬──────────────────────────────┬─────────────────────────┬────────────────┬──────┐"
   mLines[ 2] = "│Порядков│Время   │Код │ Курс  │        Наличные денежные средства       │Пла-│Принято (выдано) кассовым  │    Номер счета     │Дове-│Граж-│    ФИО физиче-     │   Документ,удостоверяющий    │   Адрес места житель-   │Дата и место    │Комис-│"
   mLines[ 3] = "│ый номер│соверше-│вида│ ино-  ├────────────────────┬────────────────────┤теж-│работником чеков (в том    │                    │рен- │дан- │    ского лица      │   личность                   │   ства (место пребы-    │рождения физи-  │сия   │"
   mLines[ 4] = "│операции│ния опе-│опе-│ стран-│    принято         │    выдано          │ная │числе дорожных чеков),     │                    │ность│ство │                    │                              │   вания)                │ческого лица    │по    │"
   mLines[ 5] = "│        │рации   │ра- │ ной   │    кассовым        │    кассовым        │кар-│номинальная стоимость кото-│                    │     │физи-│                    │                              │                         │                │опера-│"
   mLines[ 6] = "│        │ ЧЧ.ММ  │ции │ валюты│    работником      │    работником      │та  │рых указана в иностранной  │                    │     │че-  │                    │                              │                         │                │циям  │"
   mLines[ 7] = "│        │        │    │(кросс-│                    │                    │    │валюте                     │                    │     │ско- │                    │                              │                         │                │      │"
   mLines[ 8] = "│        │        │    │ -курс)├─────┬──────────────┼─────┬──────────────┼────┼──────┬─────┬──────────────│                    │     │го   │                    │                              │                         │                │      │"
   mLines[ 9] = "│        │        │    │ по оп-│код  │              │код  │              │    │коли- │код  │              │                    │     │лица │                    │                              │                         │                │      │"
   mLines[10] = "│        │        │    │ ерации│валю-│    сумма     │валю-│    сумма     │    │чество│валю-│    сумма     │                    │     │     │                    │                              │                         │                │      │"
   mLines[11] = "│        │        │    │       │ты   │              │ты   │              │    │чеков │ты   │              │                    │     │     │                    │                              │                         │                │      │"
 /*mLines[12] = "│        │        │     │             │      │                   │      │                    │         │     серия     │      │                   │                     │        │                │"*/
 /*mLines[13] = "│        │        │     │             │      │                   │      │                    │         │     номера    │      │                   │                     │        │                │"*/
   mLines[14] = "├────────┼────────┼────┼───────┼─────┼──────────────┼─────┼──────────────┼────┼──────┼─────┼──────────────┼────────────────────┼─────┼─────┼────────────────────┼──────────────────────────────┤─────────────────────────┼────────────────┼──────┤"
   mLines[15] = "│   1    │    2   │ 3  │   4   │  5  │      6       │  7  │      8       │  9 │  10  │ 11  │      12      │         13         │ 14  │ 15  │        16          │              17              │           18            │       19       │  20  │"
   mLines[21] = "├────────┼────────┼────┼───────┼─────┼──────────────┼─────┼──────────────┼────┼──────┼─────┼──────────────┼────────────────────┼─────┼─────┼────────────────────┼──────────────────────────────┼─────────────────────────┼────────────────┼──────┤"
   mLines[22] = "│        │        │    │       │ ,   │             ,│     │              │    │      │     │              │                    │     │     │                    │                              │                         │                │      │"
   mLines[23] = "└─────────────────┴────┴───────┴─────┴──────────────┴─────┴──────────────┴────┴──────┴─────┴──────────────┴────────────────────┴─────┴─────┴────────────────────┴──────────────────────────────┴─────────────────────────┴────────────────┴──────┘"
   mLines[24] = "└────────┴────────┴────┴───────┴─────┴──────────────┴─────┴──────────────┴────┴──────┴─────┴──────────────┴────────────────────┴─────┴─────┴────────────────────┴──────────────────────────────┴─────────────────────────┴────────────────┴──────┘"
   mLines[25] = "├────────┴────────┼────┼───────┼─────┼──────────────┼─────┼──────────────┼────┼──────┼─────┼──────────────┼────────────────────┼─────┼─────┼────────────────────┼──────────────────────────────┼─────────────────────────┼────────────────┼──────┤"
   mLines[26] = "├─────────────────┼────┼───────┼─────┼──────────────┼─────┼──────────────┼────┼──────┼─────┼──────────────┼────────────────────┼─────┼─────┼────────────────────┼──────────────────────────────┼─────────────────────────┼────────────────┼──────┤"
   mLines[27] = "│Итого по Реестру:│ ,  │       │     │              │     │              │    │      │     │             ,│                    │     │     │                    │                              │                         │                │,     │"
   mLines[28] = "├─────────────────┴────┴───────┴─────┴──────────────┴─────┴──────────────┴────┴──────┴─────┴──────────────┴────────────────────┴─────┴─────┴────────────────────┴──────────────────────────────┴─────────────────────────┴────────────────┴──────┤"
   mLines[29] = "├─────────────────┬────┬───────┬─────┬──────────────┬─────┬──────────────┬────┬──────┬─────┬──────────────┬────────────────────┬─────┬─────┬────────────────────┬──────────────────────────────┬─────────────────────────┬────────────────┬──────┤"
   mLines[30] = "│        │        │    │       │     │              │     │              │    │      │     │              │                    │     │     │,                   │                              │                         │                │      │"
   mCols      = LENGTH(mSpace + mLines[1])
   .
&GLOBAL-DEFINE cols mCols

{agr-beg.def 
   &NameTitle = "РЕЕСТР ОПЕРАЦИЙ С ВАЛЮТОЙ И ЧЕКАМИ 136-И"
   &TypeDoc   = '"book"'
   &NameRep   = "'ВОКРст136'"}

{limitsum.chk}
{rst-tab.fun}   /* Определение сумм, кодов валют и кол-ва чеков для единого реестра */

/*DEFINE VARIABLE mCodOurCur    AS CHARACTER NO-UNDO INIT "810".
DEFINE VARIABLE mByRate   AS LOGICAL NO-UNDO.*/
mByRate = true.
   /* CreateTemp-Table */
   DEFINE VARIABLE vCurDprId  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vVidOpNalV AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vOperIskl  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vOperRate  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vOperCard  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vOperAcct  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vOpGr15    AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vAcctComm  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vPechFIO   AS LOGICAL     NO-UNDO.
   DEFINE VARIABLE vPrSumm    AS CHARACTER   NO-UNDO /* Бал Счета комиссий */ EXTENT 2.
   /*DEFINE VARIABLE i          AS INT64       NO-UNDO.*/
   DEFINE VARIABLE vOpTime    AS INT64       NO-UNDO.
   DEFINE VARIABLE vOpLnk     AS INT64       NO-UNDO.
   DEFINE VARIABLE vOpDate    AS DATE        NO-UNDO.
   DEFINE VARIABLE vCurrDb    AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vSummaDb   AS DECIMAL     NO-UNDO.
   DEFINE VARIABLE vCurrCr    AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vSummaCr   AS DECIMAL     NO-UNDO.
   DEFINE VARIABLE vQtyCheq   AS DECIMAL     NO-UNDO.
   DEFINE VARIABLE vCurrCheq  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vSumCheq   AS DECIMAL     NO-UNDO.
   DEFINE VARIABLE vSumRub    AS DECIMAL     NO-UNDO.
   DEFINE VARIABLE vAcctCli   AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vCountry   AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vCommSign  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vCurrCom   AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vSummCom   AS DECIMAL     NO-UNDO.
   DEFINE VARIABLE vSummComR  AS DECIMAL     NO-UNDO.
   DEFINE VARIABLE vForminfo  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vRate      AS DECIMAL     NO-UNDO.
   DEFINE VARIABLE vChrRate   AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vIsSvod    AS LOGICAL     NO-UNDO.
   DEFINE VARIABLE vOp        AS INT64       NO-UNDO.
   DEFINE VARIABLE vDover     AS LOGICAL     NO-UNDO.
   DEFINE VARIABLE vSpaceRate AS CHARACTER   NO-UNDO INIT "           ".

   DEFINE BUFFER bop       FOR op.
   DEFINE BUFFER xop       FOR op.
   DEFINE BUFFER bop-entry FOR op-entry.
   DEFINE BUFFER blinks    FOR links.
   DEFINE BUFFER bsessions FOR sessions.
   DEF STREAM vvs.

   ASSIGN
      vOperIskl = FGetSetting("Реестр136-И","ОперИскл","")
      vOperRate = FGetSetting("Реестр136-И","ОперБезКурса","")
      vOperCard = FGetSetting("Реестр136-И","ОперПлат","14,15,16,17")
      vOperAcct = FGetSetting("Реестр136-И","ОперКлСч","51,52,53,54,59,60,61,62,63,64,65")
      vAcctComm = FGetSetting("И113","СчетКомис","")
      vOpGr15   = fGetSetting("И113","ОпГр15","")
      vPechFIO  = fGetSetting("ПечФИО","","Нет") EQ "Да"
      vOpLnk    = getXLinkID ("opbv-svod","opvSvod")
	  .

   FOR EACH code WHERE
            code.class EQ "ПрСуммы" 
        AND code.val   NE ""
      NO-LOCK:
      DO i = 1 TO NUM-ENTRIES(code.val):
         {additem.i vPrSumm[1] SUBSTRING(ENTRY(i,code.val),1,5)}
         {additem.i vPrSumm[2] code.code}
      END.
   END.

   DEF BUFFER bsigns1 FOR signs.
   DEFINE VARIABLE fname AS CHAR NO-UNDO.

   fname = 'ree' + STRING(YEAR(beg-date)) + STRING(MONTH(beg-date), '99') + STRING(DAY(beg-date), '99') + ".csv".
   OUTPUT STREAM vvs TO VALUE (fname)
    UNBUFFERED CONVERT  TARGET "1251" /*UTF-8"*/  SOURCE "IBM866".

  put stream vvs unformatted 
        "дата" ";"
        "подразд" ";"
        "смена" ";"
        "кассир" ";"
        "№ док" ";"
        "время" ";"
        "код оп." ";"
        "курс"  ";"
        "валюта принято" ";"
        "сумма принято" ";"
        "валюта выдано" ";"
        "сумма выдано" ";"
        "пл.карта" ";"
        "кол-чеков" ";"
        "валюта" ";"
        "сумма чеков" ";"
        "номер счета" ";"
        "дов." ";"
        "гражданство" ";"
        "ФИО" ";"
        "документ" ";"
        "адрес" ";"
        "дата место рождения" ";"
        "комиссия" ";"
        SKIP
      .


   FOR EACH sessions
     WHERE sessions.filial-id EQ shFilial 
       AND sessions.op-date >= beg-date AND sessions.op-date <= end-date
     NO-LOCK /*,
      FIRST bsigns1 /*OUTER-JOIN */
        WHERE bsigns1.file-name EQ 'sessions'
          AND bsigns1.surrogate EQ STRING(sessions.dpr-id)
          AND bsigns1.code eq 'hran' NO-LOCK*/ :
      /*IF NOT AVAIL bsigns1 THEN
         PUT UNFORMATTED " смена не hran " + STRING(sessions.dpr-id) SKIP.*/
      vCurDprId = STRING( sessions.dpr-id).
      mCuDate = sessions.op-date.
/*Message "смена " vCurDprId VIEW-AS ALERT-BOX.*/

      {empty ttRegister}
      {empty ttReg-Det}
      {empty ttRegItog}
      FOR EACH kau WHERE
               kau.kau-id BEGINS "КодСмены"
           AND kau.kau    EQ     vCurDprId
         NO-LOCK,
          EACH kau-entry WHERE
               kau-entry.kau-id    EQ kau.kau-id
           AND kau-entry.kau       EQ kau.kau
           AND kau-entry.op-date   EQ mCuDate
           AND kau-entry.op-status >= mStatus
         NO-LOCK,
         FIRST xop OF kau-entry WHERE
         NO-LOCK
         BREAK 
         BY kau-entry.op:

         IF FIRST-OF(kau-entry.op) THEN 
         DO:
            vIsSvod = NO.
            FOR EACH blinks WHERE 
                     blinks.link-id   EQ vOpLnk
                 AND blinks.source-id EQ STRING(xop.op) 
               NO-LOCK:
               vOp = INT64(blinks.target-id).
               FIND FIRST op WHERE 
                          op.op = vOp
                  NO-LOCK NO-ERROR.
               {rst-136i.i}
               vIsSvod = YES.
            END.

            IF NOT CAN-FIND(blinks WHERE 
                            blinks.link-id   EQ vOpLnk 
                        AND blinks.target-id EQ STRING(xop.op) NO-LOCK)
               AND vIsSvod EQ NO THEN
            DO:
               FIND FIRST op WHERE 
                          op.op = xop.op 
                  NO-LOCK NO-ERROR.
               {rst-136i.i}
            END.
         END.
      END.
      /* Создание пустых реестров */ 
      IF fGetSetting("Реестр136-И","ВсеДниСмены","Да") EQ "Нет" THEN
      DO:
         IF NOT CAN-FIND(FIRST ttRegister WHERE 
                               ttRegister.dpr-id EQ INT(vCurDprId)) THEN
         DO:
            CREATE ttRegister.
            ASSIGN
               ttRegister.dpr-id   = INT(vCurDprId)
               ttRegister.vain     = YES
               ttRegister.doc-date = mCuDate
               .
            RELEASE ttRegister.
         END.
      END.   
      ELSE
      DO: 
         FIND FIRST bsessions WHERE 
                    bsessions.dpr-id EQ INT64(vCurDprId)
            NO-LOCK NO-ERROR.
         IF AVAIL bsessions THEN
         DO:
            DO i = 0 TO ((IF bsessions.dpr-status EQ "ЗАКРЫТА" THEN bsessions.dpr-close ELSE TODAY) - bsessions.dpr-open):
               IF NOT CAN-FIND(FIRST ttRegister WHERE 
                                     ttRegister.dpr-id   EQ INT(vCurDprId)
                                 AND ttRegister.doc-date EQ bsessions.dpr-open + i) THEN
               DO:
                  CREATE ttRegister.
                  ASSIGN
                     ttRegister.dpr-id   = INT(vCurDprId)
                     ttRegister.vain     = YES
                     ttRegister.doc-date = bsessions.dpr-open + i
                     .
                  RELEASE ttRegister.
               END.
            END.                 
         END.
      END.



   /* PrintRst */
   DEFINE VARIABLE vREGN       AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vLogDocNum  AS LOGICAL     NO-UNDO.
   DEFINE VARIABLE vAdresPch   AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vBank       AS CHARACTER   NO-UNDO EXTENT 2.
   DEFINE VARIABLE vBranchAttr AS CHARACTER   NO-UNDO EXTENT 2.
   DEFINE VARIABLE vRstNum     AS INT64       NO-UNDO.
   DEFINE VARIABLE vDocNum     AS INT64       NO-UNDO.
   DEFINE VARIABLE vStrDate    AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vFirst      AS LOGICAL     NO-UNDO.
   DEFINE VARIABLE vFio        AS CHARACTER   NO-UNDO EXTENT 5.
   DEFINE VARIABLE vPasport    AS CHARACTER   NO-UNDO EXTENT 5.
   DEFINE VARIABLE vAdress     AS CHARACTER   NO-UNDO EXTENT 5.
   DEFINE VARIABLE vBirthDay   AS CHARACTER   NO-UNDO EXTENT 5.
   DEFINE VARIABLE vSessBrnch  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vKodFil     AS CHARACTER   NO-UNDO.
   /*DEFINE VARIABLE vOperAcct   AS CHARACTER   NO-UNDO.*/
   DEFINE VARIABLE vLinePtint  AS INT64       NO-UNDO.
   DEFINE VARIABLE vDoverNum   AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vDoverCid   AS INT64       NO-UNDO.
   /*DEFINE VARIABLE mCuBrchID   AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE mBank         AS CHARACTER NO-UNDO.*/

   DEFINE BUFFER bttRegister FOR ttRegister.
   /* DEFINE BUFFER bsessions   FOR sessions. */

   FIND FIRST bsessions WHERE bsessions.dpr-id EQ INT64( sessions.dpr-id /*mCuDprID*/ ) NO-LOCK NO-ERROR.
   IF AVAIL bsessions THEN
      vSessBrnch = bsessions.branch-id.
   mCuBrchID = bsessions.branch-id.

   RUN HeadInRep.
   RUN FootInRep.
      
   IF NOT {assigned vSessBrnch} THEN
      vSessBrnch = mCuBrchID.

   ASSIGN
      vREGN          = FGetSetting("REGN",?,"")
      vREGN          = vREGN
      vAdresPch      = FGetSetting("Адрес_пч",?,?)
      vBank[1]       = mBank
      vKodFil        = FGetSetting("КодФил",?,"")
      vBranchAttr[1] = IF vKodFil NE vSessBrnch THEN mBranchName + " " + mVOKAddr[1]
                                                ELSE ""
      vLogDocNum     = fGetSetting("Реестр136-И","ДокНум","Нет") EQ "Нет"
      vOperAcct      = FGetSetting("Реестр136-И","ОперКлСч","51,52,53,54,59,60,61,62,63,64,65")
      .

   {wordwrap.i
     &s = vBank
     &n = 2
     &l = 60
   }
   {wordwrap.i
     &s = vBranchAttr
     &n = 2
     &l = 60
   }

   FOR EACH ttRegister 
      NO-LOCK
      BREAK 
      BY ttRegister.dpr-id
      BY ttRegister.doc-date 
      BY ttRegister.doc-time:
      IF FIRST-OF(ttRegister.dpr-id) THEN
      DO:
         vRstNum = 0.
         RUN GetRepFioByRef(mNameRep, mCuBrchID,ttRegister.op,ttRegister.dpr-id).
      END.
      IF FIRST-OF(ttRegister.doc-date) THEN
      DO:
         ASSIGN
            vRstNum  = vRstNum + 1 WHEN NOT ttRegister.vain
            vDocNum  = 0
            vStrDate = STRING(ttRegister.doc-date,"99.99.9999") /* {strdate.i ttRegister.doc-date} */
            .
         IF ttRegister.vain THEN
         DO:
            PUT UNFORMATTED
               mSpace SPACE(3) "Полное (сокращенное) фирменное наименование"          SPACE(11) vBank[1]       SKIP
               mSpace SPACE(3) "уполномоченного банка"                                SPACE(33) vBank[2]       SKIP
               mSpace SPACE(3) "(наименование филиала)"                                                        SKIP
               mSpace SPACE(3) "Регистрационный номер уполномоченного банка/"         SPACE(10) STRING(vREGN)  SKIP
               mSpace SPACE(3) "порядковый номер филиала"                                                      SKIP
               mSpace SPACE(3) "Местонахождение (адрес) уполномоченного банка"        SPACE(9) vAdresPch       SKIP
               mSpace SPACE(3) "(филиала)"                                                                     SKIP
               mSpace SPACE(3) "Наименование внутреннего структурного подразделения"  SPACE(3) vBranchAttr[1]  SKIP
               mSpace SPACE(3) "уполномоченного банка и его местонахождение (адрес)"  SPACE(3) vBranchAttr[2]  SKIP
               mSpace SPACE(3) "Дата заполнения справки"
                      SPACE(31) "┌─┬─┐ ┌─┬─┐ ┌─┬─┬─┬─┐" SKIP
               mSpace SPACE(57) "│" SUBSTRING(vStrDate,1,1) "│" SUBSTRING(vStrDate,2,1) "│.│" SUBSTRING(vStrDate,4,1) "│" SUBSTRING(vStrDate,5,1)
               "│.│" SUBSTRING(vStrDate,7,1) "│" SUBSTRING(vStrDate,8,1) "│" SUBSTRING(vStrDate,9,1) "│" SUBSTRING(vStrDate,10,1) "│" SKIP
               mSpace SPACE(57) "└─┴─┘ └─┴─┘ └─┴─┴─┴─┘" SKIP
               mSpace SPACE(57) "День  Месяц    Год   " SKIP


               PADC("СПРАВКА ОБ ОТСУТСТВИИ ОПЕРАЦИЙ С НАЛИЧНОЙ ВАЛЮТОЙ И ЧЕКАМИ",110)                   SKIP(1)
               mSpace SPACE(3) "В течение рабочего дня операции с наличной иностранной валютой и чеками не осуществлялись." SKIP(1)
            .
            DO i = 1 TO mTotalSign:
               RUN PrintFioAndPostP(CutFio(mFioInRep[i]),"Кассовый работник",length(mSpace)).
            END.
            NEXT.
         END.
         PUT UNFORMATTED
            mSpace SPACE(3) "Полное (сокращенное) фирменное наименование"          SPACE(11) vBank[1]              SKIP
            mSpace SPACE(3) "уполномоченного банка"                                SPACE(33) vBank[2]              SKIP
            mSpace SPACE(3) "(наименование филиала)"                                                               SKIP
            mSpace SPACE(3) "Регистрационный номер уполномоченного банка/"         SPACE(10) STRING(vREGN)         SKIP
            mSpace SPACE(3) "порядковый номер филиала"                                                             SKIP
            mSpace SPACE(3) "Местонахождение (адрес) уполномоченного банка"        SPACE(9) vAdresPch              SKIP
            mSpace SPACE(3) "(филиала)"                                                                            SKIP
            mSpace SPACE(3) "Наименование внутреннего структурного подразделения"  SPACE(3) vBranchAttr[1]         SKIP
            mSpace SPACE(3) "уполномоченного банка и его местонахождение (адрес)"  SPACE(3) vBranchAttr[2]         SKIP
            mSpace SPACE(3) "Дата заполнения реестра"
                   SPACE(31) "┌─┬─┐ ┌─┬─┐ ┌─┬─┬─┬─┐" SKIP
            mSpace SPACE(57) "│" SUBSTRING(vStrDate,1,1) "│" SUBSTRING(vStrDate,2,1) "│.│" SUBSTRING(vStrDate,4,1) "│" SUBSTRING(vStrDate,5,1)
            "│.│" SUBSTRING(vStrDate,7,1) "│" SUBSTRING(vStrDate,8,1) "│" SUBSTRING(vStrDate,9,1) "│" SUBSTRING(vStrDate,10,1) "│" SKIP
            mSpace SPACE(57) "└─┴─┘ └─┴─┘ └─┴─┴─┴─┘" SKIP
            mSpace SPACE(57) "День  Месяц    Год   " SKIP(1)
            mSpace SPACE(3) "Порядковый номер Реестра в течение рабочего дня"      SPACE(7) vRstNum SKIP
            PADC("Реестр операций с наличной валютой и чеками",mCols)                                       SKIP(1)
         .
         DO i = 1 TO 20:
            IF mLines[i] NE "" THEN
               PUT UNFORMATTED mSpace mLines[i] SKIP.
         END.
      END.
      
      IF     LAST-OF(ttRegister.doc-date) 
         AND NOT CAN-FIND(FIRST ttRegItog WHERE 
                                ttRegItog.doc-date EQ ttRegister.doc-date) THEN
      DO:
         vLinePtint = GetFioPostLine() + 2.
         IF mLogComm THEN
            FOR EACH ttReg-Det WHERE
                     ttReg-Det.op EQ ttRegister.op
               NO-LOCK:
               vLinePtint = vLinePtint + 1.
            END.         
         IF LINE-COUNTER + vLinePtint > PAGE-SIZE THEN 
            PAGE.         
      END.
     
     IF CAN-DO(vOperAcct,ttRegister.doc-kind) AND NOT ttRegister.dover THEN 
        RUN GetFioByAcct(ttRegister.op,OUTPUT vFio[1],OUTPUT vPasport[1],OUTPUT vAdress[1],OUTPUT vBirthDay[1]).
     ELSE 
        IF ttRegister.dover THEN DO:
         vDoverNum = GetXAttrValue("op", STRING(ttRegister.op), "proxy-code").
         FIND FIRST loan 
             WHERE loan.cont-code = vDoverNum
             AND   loan.contract  = "proxy"
         NO-LOCK NO-ERROR.
         IF AVAIL loan THEN
            vDoverCid = INTEGER(GetXAttrValue("loan", loan.contract + "," + vDoverNum, "agent-id")).
            FIND FIRST person
                 WHERE person.person-id = vDoverCid
            NO-LOCK NO-ERROR.
            IF AVAIL person THEN
               ASSIGN
                vFio[1]      = person.name-last + " " + person.first-names
                vAdress[1]   = person.address[1]
                vBirthDay[1] = STRING(person.birthday) + " " +
                               GetXAttrValueEx("person",STRING(person.person-id),"BirthPlace","")
                vPasport[1]  = person.document-id + " " + person.document + " " + fGetDocIssue(person.person-id)
               .
        END.
        ELSE
          ASSIGN
          vFio[1]      = GetXAttrValue("op", STRING(ttRegister.op), "ФИО")
          vAdress[1]   = GetXAttrValue("op", STRING(ttRegister.op), "Адрес")
          vBirthDay[1] = GetXAttrValue("op", STRING(ttRegister.op), "birthday") + "  " +
                     GetXAttrValueEx("op", STRING(ttRegister.op), "birthPlace","")
          vPasport[1]  = GetPassport(ttRegister.op)
          .

      vDocNum = vDocNum + 1.


     /* в файл */

     PUT STREAM vvs UNFORMATTED
        STRING( ttRegister.doc-date) ";"
        '="' mCuBrchID '"' ";"
        ttRegister.dpr-id ";"
        mFIOInRep[ 1] ";"
        STRING(IF vLogDocNum THEN vDocNum ELSE ttRegister.doc-num,">>>>>9") ";"
        STRING(ttRegister.doc-time,"HH:MM") ";"
        STRING('="' + ttRegister.doc-kind + '"') ";"
        (IF (ttRegister.amt-db EQ 0 OR ttRegister.amt-cr EQ 0 OR ttRegister.card EQ TRUE) THEN "" ELSE STRING(TRIM(STRING(ttRegister.ChRate))))  ";"
        STRING(ttRegister.curr-db) ";"
        (IF ttRegister.amt-db NE 0 THEN STRING(ttRegister.amt-db, ">>>,>>>,>>9.99") ELSE "") ";"
        STRING(ttRegister.curr-cr) ";"
        (IF ttRegister.amt-cr NE 0 THEN STRING(ttRegister.amt-cr, ">>>,>>>,>>9.99") ELSE "") ";"
        STRING(ttRegister.card,"X/")  ";"
        (IF ttRegister.cheq-qty NE 0 THEN STRING(ttRegister.cheq-qty, ">>>,>>9") ELSE "") ";"
        STRING(ttRegister.currcheq) ";"
        (IF ttRegister.amt-cheq NE 0 THEN STRING(ttRegister.amt-cheq, ">>>,>>>,>>9.99") ELSE "") ";"
        STRING('="' + ENTRY( 1, ttRegister.acct, '@') + '"') ";"
        STRING(ttRegister.dover,"X/") ";"
        STRING(ttRegister.country) ";"
        '"' + REPLACE( REPLACE(STRING(vFio[1]), '"', "'"), ';', ":") '"' ";"
        '"' + REPLACE( REPLACE(STRING(vPasport[1]), '"', "'"), ';', ":") '"'  ";"
        '"' + REPLACE( REPLACE(STRING(vAdress[1]), '"', "'"), ';', ":") '"' ";"
        STRING(vBirthDay[1]) ";".
     FIND FIRST ttReg-Det WHERE 
             ttReg-Det.op EQ ttRegister.op 
          AND ttReg-Det.currency NE "810"
     NO-LOCK NO-ERROR.
     IF AVAIL ttReg-Det THEN 
     PUT STREAM vvs UNFORMATTED
         (IF ttReg-Det.Summa NE 0 THEN STRING(ttReg-Det.Summa, ">>9.99") ELSE "")
         SKIP.
     ELSE PUT STREAM vvs UNFORMATTED /*ENTRY(4,mLines[27])*/ SKIP.
     /* */



      {wordwrap.i
       &s = vFio
       &n = 5
       &l = 20
      }
      {wordwrap.i
       &s = vPasport
       &n = 5
       &l = 30
      }
      {wordwrap.i
       &s = vAdress
       &n = 5
       &l = 25
      }
      {wordwrap.i
       &s = vBirthDay
       &n = 5
       &l = 17
      }

      PUT UNFORMATTED 
           mSpace mLines[21] SKIP mSpace
           "│ "  STRING(IF vLogDocNum THEN vDocNum ELSE ttRegister.doc-num,">>>>>9") 
          " │ "  REPLACE(STRING(ttRegister.doc-time,"HH:MM"),":",".") /* STRING(ttRegister.doc-time,"HH:MM") */
         "  │ "  STRING(ttRegister.doc-kind,"x(2)")
        " │"   (IF (ttRegister.amt-db EQ 0 OR ttRegister.amt-cr EQ 0 OR ttRegister.card EQ TRUE) THEN "       " ELSE STRING(TRIM(STRING(ttRegister.ChRate)), "x(7)")) 
           "│ "  STRING(ttRegister.curr-db,"x(3)")
          " │"   (IF ttRegister.amt-db NE 0 THEN STRING(ttRegister.amt-db, ">>>,>>>,>>9.99") ELSE "              ")
           "│ "  STRING(ttRegister.curr-cr,"x(3)")
          " │"   (IF ttRegister.amt-cr NE 0 THEN STRING(ttRegister.amt-cr, ">>>,>>>,>>9.99") ELSE "              ")
           "│  " STRING(ttRegister.card,"X/") 
          " │"   (IF ttRegister.cheq-qty NE 0 THEN STRING(ttRegister.cheq-qty, ">>>,>>9") ELSE "      ")
           "│ "  STRING(ttRegister.currcheq,"x(3)")
          " │"   (IF ttRegister.amt-cheq NE 0 THEN STRING(ttRegister.amt-cheq, ">>>,>>>,>>9.99") ELSE "              ")
           "│"   STRING(ttRegister.acct,"x(20)")
           "│ "  STRING(ttRegister.dover,"X/")
      "   │ "  STRING(ttRegister.country,"x(3)")
        " │"   STRING(vFio[1], "x(20)")
           "│"   STRING(vPasport[1], "x(30)") 
           "│"   STRING(vAdress[1],"x(25)")
           "│"   STRING(vBirthDay[1], "x(16)").
     FIND FIRST ttReg-Det WHERE 
             ttReg-Det.op EQ ttRegister.op 
          AND ttReg-Det.currency NE "810"
     NO-LOCK NO-ERROR.
     IF AVAIL ttReg-Det THEN 
     PUT UNFORMATTED
         "│"  (IF ttReg-Det.Summa NE 0 THEN STRING(ttReg-Det.Summa, ">>9.99") ELSE "      ") "│"
         SKIP.
     ELSE PUT UNFORMATTED "│ " ENTRY(4,mLines[27]) SKIP.

     DO i = 2 TO 5:
        IF    vFio[i]      NE ""
          OR vBirthDay[i] NE "" 
          OR vAdress[i]   NE "" 
          OR vPasport[i]  NE "" THEN
          PUT UNFORMATTED
            ENTRY(1,mLines[30]) 
            STRING(vFio[i], "x(20)")
         "│" STRING(vPasport[i], "x(30)") 
            "│" STRING(vAdress[i],"x(25)")
            "│" STRING(vBirthDay[i], "x(16)") "│ " ENTRY(4,mLines[27])
            SKIP.
     END.


      /*IF mLogComm THEN
      DO:
         FOR EACH ttReg-Det WHERE
                  ttReg-Det.op EQ ttRegister.op
            NO-LOCK:
            PUT UNFORMATTED 
               mSpace ENTRY(1,mLines[22]) ttReg-Det.Currency "  │ " STRING(ttReg-Det.SummSign,"x(3)") " " STRING(ttReg-Det.Summa, ">>>,>>>,>>9.99") ENTRY(3,mLines[22]) SKIP.
               Message STRING(ttReg-Det.Summa, ">>>,>>>,>>9.99") VIEW-AS ALERT-BOX.
         END.
      END.*/

      IF LAST-OF(ttRegister.doc-date) THEN
      DO:
         vFirst = YES.
         IF NOT CAN-FIND(FIRST ttRegItog WHERE 
                               ttRegItog.doc-date EQ ttRegister.doc-date) THEN
         DO:
            PUT UNFORMATTED 
               mSpace mLines[24] SKIP.
         END.
         ELSE
         DO:
            IF mFullItg THEN
            DO:
               PUT UNFORMATTED 
                  mSpace mLines[28] SKIP
                  mSpace "│ Итоги по видам операций в разрезе курсов                                                                                                                                                           │ " SKIP.
               FOR EACH ttRegItog WHERE 
                        ttRegItog.doc-date EQ ttRegister.doc-date
                    AND ttRegItog.ChRate   NE ""
                  NO-LOCK:
                  IF vFirst THEN
                  DO:
                     vFirst = NO.
                     PUT UNFORMATTED 
                        mSpace mLines[29] SKIP.
                  END.
                  ELSE
                     PUT UNFORMATTED 
                        mSpace mLines[26] SKIP.
   
                  PUT UNFORMATTED 
                     mSpace ENTRY(1,mLines[27])
                     STRING(ttRegItog.doc-kind,"x(2)")
           " │"   (IF (ttRegItog.amt-db EQ 0 OR ttRegItog.amt-cr EQ 0) THEN "       " ELSE STRING(TRIM(STRING(ttRegItog.ChRate)),"x(7)") )
            "│ "  STRING(ttRegItog.curr-db,"x(3)")
           " │"   (IF ttRegItog.amt-db NE 0 THEN STRING(ttRegItog.amt-db, ">>>,>>>,>>9.99") ELSE "              ")
            "│ "  STRING(ttRegItog.curr-cr,"x(3)")
           " │"   (IF ttRegItog.amt-cr NE 0 THEN STRING(ttRegItog.amt-cr, ">>>,>>>,>>9.99") ELSE "              ")
            "│    │" (IF ttRegItog.cheq-qty NE 0 THEN STRING(ttRegItog.cheq-qty, ">>>,>>9") ELSE "      ")
            "│ "  STRING(ttRegItog.currcheq,"x(3)")
              " │"   (IF ttRegItog.amt-cheq NE 0 THEN STRING(ttRegister.amt-cheq, ">>>,>>>,>>9.99") ELSE "              ")
                     ENTRY(3,mLines[27]) 
                (IF ttRegItog.Summa NE 0 THEN STRING(ttRegItog.Summa,">>9.99") ELSE "      ")
             "│"   SKIP.
               END.
               vFirst = YES.
               PUT UNFORMATTED 
                  mSpace mLines[28] SKIP
                  mSpace "│ Итоги по видам операций                                                                                                                                                                            │ " SKIP.
            END.

            FOR EACH ttRegItog WHERE 
                     ttRegItog.doc-date EQ ttRegister.doc-date
                 AND (ttRegItog.ChRate   EQ "" OR NOT mFullItg)
               NO-LOCK
               BREAK BY ttRegItog.doc-date:
                  
               IF vFirst THEN
               DO:
                  vFirst = NO.
                   
                  PUT UNFORMATTED mSpace
                     (IF mFullItg THEN mLines[29] ELSE mLines[25]) SKIP.
               END.
               ELSE
                  PUT UNFORMATTED 
                     mSpace mLines[26] SKIP.

               IF     LAST-OF(ttRegItog.doc-date) THEN
               DO:
                  vLinePtint = GetFioPostLine() + 1.    
                  IF LINE-COUNTER + vLinePtint > PAGE-SIZE THEN
                  DO: 
                     PAGE.
                  END.   
               END.

               PUT UNFORMATTED 
                  mSpace ENTRY(1,mLines[27])
                 STRING(ttRegItog.doc-kind,"x(2)")
        " │"   (IF (ttRegItog.amt-db EQ 0 OR ttRegItog.amt-cr EQ 0) THEN "       " ELSE STRING(TRIM(STRING(ttRegItog.ChRate)),"x(7)"))
         "│ "  STRING(ttRegItog.curr-db,"x(3)")
        " │"   (IF ttRegItog.amt-db NE 0 THEN STRING(ttRegItog.amt-db, ">>>,>>>,>>9.99") ELSE "              ")
         "│ "  STRING(ttRegItog.curr-cr,"x(3)")
        " │"   (IF ttRegItog.amt-cr NE 0 THEN STRING(ttRegItog.amt-cr, ">>>,>>>,>>9.99") ELSE "              ")
         "│    │" (IF ttRegItog.cheq-qty NE 0 THEN STRING(ttRegItog.cheq-qty, ">>>,>>9") ELSE "      ")
         "│ "  STRING(ttRegItog.currcheq,"x(3)")
        " │"   (IF ttRegItog.amt-cheq NE 0 THEN STRING(ttRegister.amt-cheq, ">>>,>>>,>>9.99") ELSE "              ")
                 ENTRY(3,mLines[27]) 
             (IF ttRegItog.Summa NE 0 THEN STRING(ttRegItog.Summa,">>9.99") ELSE "      ")
         "│"    SKIP.
            END.
            PUT UNFORMATTED 
               mSpace mLines[23] SKIP(1).
         END.

         DO i = 1 TO mTotalSign:
            RUN PrintFioAndPostP(CutFio(mFioInRep[i]),"Кассовый работник",length(mSpace)).
         END.

         PAGE.
         /* Приложение к реестру */
         IF mRstPril THEN
         DO:
            vDocNum = 0.
            PUT UNFORMATTED
               mSpace SPACE(3) "ПРИЛОЖЕНИЕ К РЕЕСТРУ ОПЕРАЦИЙ С НАЛИЧНОЙ ИНОСТРАННОЙ ВАЛЮТОЙ И ЧЕКАМИ"
               SKIP(1)
               mSpace SPACE(3) "Адрес структурного подразделения         " mVOKAddr[1]
               SKIP(1)
               mSpace SPACE(3) "Дата заполнения Приложения               " {strdate.i mCuDate}
               SKIP(1)
               mSpace SPACE(3) "Порядковый номер Реестра, к которому     " SKIP
               mSpace SPACE(3) "прилагается данное Приложение            " STRING(vRstNum)
               SKIP(1)                                                                 
               SKIP mSpace "┌──────┬──────────────────────────────────────┬────────────────────────┬─────────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────┐"
               SKIP mSpace "│ Номер│         ФИО физического лица         │ Дата и место рождения  │                      Адрес физического лица                     │         Наименование документа, удостоверяющего личность         │"
               SKIP mSpace "│      │                                      │ физического лица       │                                                                 │                                                                  │"
               SKIP mSpace "├──────┼──────────────────────────────────────┼────────────────────────┼─────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────┤"
               SKIP mSpace "│  1   │                  2                   │            3           │                                4                                │                                   5                              │"
               .
            
            FOR EACH bttRegister WHERE
                     bttRegister.dpr-id   EQ ttRegister.dpr-id
                 AND bttRegister.doc-date EQ ttRegister.doc-date NO-LOCK
               BY bttRegister.doc-time:
            
               IF CAN-DO(vOperAcct,bttRegister.doc-kind) THEN
                  RUN GetFioByAcct(bttRegister.op,OUTPUT vFio[1],OUTPUT vPasport[1],OUTPUT vAdress[1],OUTPUT vBirthDay[1]).
               ELSE
                  ASSIGN
                     vFio[1]      = GetXAttrValue("op", STRING(bttRegister.op), "ФИО")
                     vAdress[1]   = GetXAttrValue("op", STRING(bttRegister.op), "Адрес")
                     vBirthDay[1] = GetXAttrValue("op", STRING(bttRegister.op), "birthday") + "  " +
                                    GetXAttrValueEx("op", STRING(bttRegister.op), "birthPlace","")
                     vPasport[1]  = GetPassport(bttRegister.op)
                  .
               {wordwrap.i
                 &s = vFio
                 &n = 5
                 &l = 35
               }
               {wordwrap.i
                 &s = vBirthDay
                 &n = 5
                 &l = 20
               }
               {wordwrap.i
                 &s = vAdress
                 &n = 5
                 &l = 64
               }
               {wordwrap.i
                 &s = vPasport
                 &n = 5
                 &l = 64
               }
               /* Печать приложения */
               vDocNum = vDocNum + 1.
               PUT UNFORMATTED
                  SKIP mSpace "├──────┼──────────────────────────────────────┼────────────────────────┼─────────────────────────────────────────────────────────────────┼──────────────────────────────────────────────────────────────────┤"
                  SKIP mSpace "│" STRING(IF vLogDocNum THEN vDocNum ELSE bttRegister.doc-num, ">>>>>9")
                       "│ " STRING(vFio[1], "x(36)")
                       " │ " STRING(vBirthDay[1], "x(22)")
                       " │ " STRING(vAdress[1],"x(63)")
                       " │ " STRING(vPasport[1], "x(64)") " │"
                  .
               DO i = 2 TO 5:
                  IF    vFio[i]      NE ""
                     OR vBirthDay[i] NE "" 
                     OR vAdress[i]   NE "" 
                     OR vPasport[i]  NE "" THEN
                     PUT UNFORMATTED
                   SKIP mSpace "│      │ " STRING(vFio[i], "x(36)")
                        " │ " STRING(vBirthDay[i], "x(22)") 
                        " │ " STRING(vAdress[i],"x(63)")
                        " │ " STRING(vPasport[i], "x(64)") " │".
               END.
            END.
            
            PUT UNFORMATTED
               SKIP mSpace "└──────┴──────────────────────────────────────┴────────────────────────┴─────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────┘"
               SKIP(1)
               .
            
            PAGE.
         END.
      END.
   END.
   END.   
output stream vvs close.
{preview.i}

RUN sndbispc ("file=" + fname + ";class=bq").

{intrface.del}

PROCEDURE GetCountry.

   DEFINE VARIABLE vFIO      AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vPassport AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vAddress  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vResident AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vBirthDay AS CHARACTER NO-UNDO.
   DEFINE VARIABLE vBirthPlace AS CHARACTER NO-UNDO.

   DEFINE OUTPUT PARAMETER oCountry AS CHARACTER   NO-UNDO.
   IF NOT AVAIL op THEN
      RETURN.

   oCountry = GetXAttrValue("op",STRING(op.op), "country-pers").
   IF NOT {assigned oCountry} THEN
      RUN GetClParamByAcct(op.op, YES, OUTPUT oCountry, OUTPUT vFIO, OUTPUT vPassport, OUTPUT vAddress, OUTPUT vResident,OUTPUT vBirthDay,OUTPUT vBirthPlace).
   ELSE
      IF     oCountry NE "nnn" 
         AND oCountry NE "999" THEN
      DO:
         FIND FIRST country WHERE 
                    country.country-id EQ oCountry
            NO-LOCK NO-ERROR.                
         oCountry = IF AVAILABLE country THEN
                        STRING(country.country-alt-id,"999")
                     ELSE
                        oCountry.
      END.
      ELSE
         oCountry = "".

END PROCEDURE.

FUNCTION GetPassport CHAR (iOp AS INT64):
   DEF VAR vPassport   AS CHAR NO-UNDO.
   DEF VAR vCustDocWho AS CHAR NO-UNDO.
   DEF VAR vKp         AS CHAR NO-UNDO. 
   /* Проверяем, введен ли паспорт на документе */
   vPassport   = GetXAttrValue("op", STRING(iOp), "Докум").
   IF vPassport NE "" THEN
   DO:
   /* Получаем номер документа */
      vKp         = GetXAttrValue("op", STRING(iOp), "подразд").
      vCustDocWho = GetXAttrValue("op", STRING(iOp), "cust-doc-who").
      IF {assigned vCustDocWho} THEN
         IF {assigned vKp} THEN 
            IF NUM-ENTRIES(vCustDocWho) > 1 THEN
               ENTRY(2,vCustDocWho) = " К\П " + vKp.
            ELSE
               vCustDocWho = vCustDocWho + ", К\П " + vKp.
      ELSE
         IF NUM-ENTRIES(vCustDocWho) > 1 THEN
            ENTRY(2,vCustDocWho) = " К\П " + ENTRY(2,vCustDocWho).

      vPassport   =  GetCodeName("КодДокум",GetXAttrValue("op", STRING(iOp), "document-id"))  
         + ", " + vPassport
         + ", " + vCustDocWho
         + ", " + GetXAttrValue("op", STRING(iOp), "Document4Date_vid")
         .
   END.
   /* Убираем лишние запятые */
   vPassport = TRIM(REPLACE(REPLACE(vPassport, ", , ", ", "), ", , ", ", "), ", ").

   RETURN vPassport.
END FUNCTION.

/* Определение параметров клиента по счетам проводок */
PROCEDURE GetFioByAcct. 
   DEFINE INPUT  PARAMETER iOp       AS INT64       NO-UNDO.
   DEFINE OUTPUT PARAMETER oFio      AS CHARACTER   NO-UNDO.
   DEFINE OUTPUT PARAMETER oPasport  AS CHARACTER   NO-UNDO.
   DEFINE OUTPUT PARAMETER oAddress  AS CHARACTER   NO-UNDO.
   DEFINE OUTPUT PARAMETER oBirthDay AS CHARACTER   NO-UNDO.

   DEFINE VARIABLE vCountry   AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vResident  AS CHARACTER   NO-UNDO.
   DEFINE VARIABLE vBirthPlace  AS CHARACTER   NO-UNDO.

   RUN GetClParamByAcct(iOp, YES, OUTPUT vCountry, OUTPUT oFio, OUTPUT oPasport, OUTPUT oAddress, OUTPUT vResident, OUTPUT oBirthDay,OUTPUT vBirthPlace).
   oBirthDay = oBirthDay + " " + vBirthPlace.

END PROCEDURE. /* GetFioByAcct */

/* Определение параметров клиента по счетам проводок */
FUNCTION CutFio CHAR (iFio AS CHARACTER):

   DEFINE VARIABLE i    AS INT64       NO-UNDO.
   DEFINE VARIABLE vIO  AS CHARACTER   NO-UNDO.
   
   IF NUM-ENTRIES(iFio," ") > 2 THEN
   DO:
      DO i = NUM-ENTRIES(iFio," ") TO (NUM-ENTRIES(iFio," ") - 1) BY -1:
         vIO = SUBSTRING(ENTRY(i,iFio," "),1,1) + "." + vIO.      
      END.
      DO i = NUM-ENTRIES(iFio," ") TO (NUM-ENTRIES(iFio," ") - 2) BY -1:
         ENTRY(i,iFio," ") = " ".
      END.
   END.

   RETURN RIGHT-TRIM(iFio) + " " + vIO.

END FUNCTION. /* GutFio */

PROCEDURE CrItog.
   DEFINE INPUT  PARAMETER iChrRate AS CHARACTER   NO-UNDO.
   FIND FIRST ttRegItog WHERE 
              ttRegItog.doc-date EQ ttRegister.doc-date
          AND ttRegItog.doc-kind EQ ttRegister.doc-kind
          AND ttRegItog.ChRate   EQ iChrRate
          AND ttRegItog.curr-db  EQ ttRegister.curr-db
          AND ttRegItog.curr-cr  EQ ttRegister.curr-cr
          AND ttRegItog.currcheq EQ ttRegister.currcheq
      EXCLUSIVE-LOCK NO-ERROR.
   FIND FIRST ttReg-Det WHERE
			  ttReg-Det.Op      = ttRegister.Op 
		  AND ttReg-Det.doc-kind = ttRegister.doc-kind
		  AND ttReg-Det.currency NE "810"
   EXCLUSIVE-LOCK NO-ERROR.
   IF NOT AVAIL ttRegItog THEN
   DO:
      CREATE ttRegItog.
      ASSIGN
         ttRegItog.doc-date = ttRegister.doc-date
         ttRegItog.doc-kind = ttRegister.doc-kind
         ttRegItog.ChRate   = iChrRate
         ttRegItog.curr-db  = ttRegister.curr-db 
         ttRegItog.amt-db   = ttRegister.amt-db
         ttRegItog.curr-cr  = ttRegister.curr-cr
         ttRegItog.amt-cr   = ttRegister.amt-cr
         ttRegItog.cheq-qty = ttRegister.cheq-qty
         ttRegItog.currcheq = ttRegister.currcheq
         ttRegItog.amt-cheq = ttRegister.amt-cheq
         .
	  IF AVAIL ttReg-Det THEN
		 ttRegItog.Summa   = ttReg-Det.Summa.
   END.
   ELSE DO:
      ASSIGN
         ttRegItog.amt-db   = ttRegItog.amt-db   + ttRegister.amt-db
         ttRegItog.amt-cr   = ttRegItog.amt-cr   + ttRegister.amt-cr
         ttRegItog.cheq-qty = ttRegItog.cheq-qty + ttRegister.cheq-qty
         ttRegItog.amt-cheq = ttRegItog.amt-cheq + ttRegister.amt-cheq
         .
	  IF AVAIL ttReg-Det THEN
		 ttRegItog.Summa   = ttRegItog.Summa + ttReg-Det.Summa.
	END.
END PROCEDURE.

PROCEDURE PrintFioAndPostP.

   DEFINE INPUT PARAMETER iFio    AS CHARACTER NO-UNDO. /* ФИО которое печатаем               */
   DEFINE INPUT PARAMETER iPost   AS CHARACTER NO-UNDO. /* Должность которую печатаем         */
   DEFINE INPUT PARAMETER iOtstup AS INT64     NO-UNDO. /* ОТСТУП от края, если не нужен то 0 */

   DEFINE VARIABLE vPost AS CHARACTER NO-UNDO EXTENT 7.
   DEFINE VARIABLE vSignLength AS INT64       NO-UNDO.
   DEFINE VARIABLE i     AS INT64     NO-UNDO.

   vSignLength    = 22.
   mMaxLengthFio  = MAX(mMaxLengthFio,0).
   mMaxLengthPost = MIN(50,mMaxLengthPost).
   IF LENGTH(iPost) > 50 THEN
   DO:
      mMaxLengthPost = 50.
      vPost[1] = iPost.
      {wordwrap.i
         &s = vPost
         &n = 6 
         &l = mMaxLengthPost
      }
      DO i = 1 TO 6:
         IF vPost[i + 1] EQ "" THEN 
         DO:
            PUT UNFORMATTED 
               SPACE(iOtstup) PADC(vPost[i],mMaxLengthPost) SPACE(3) FILL('_', vSignLength) SPACE(3) PADC(iFio,mMaxLengthFio) SKIP.
            LEAVE.
         END.
         ELSE
            PUT UNFORMATTED 
               SPACE(iOtstup) PADC(vPost[i],mMaxLengthPost) SKIP.
      END.
   END.
   ELSE
   DO:
      PUT UNFORMATTED
         SPACE(iOtstup) PADC(iPost,mMaxLengthPost) SPACE(3) FILL('_', vSignLength) SPACE(3) PADC(iFio,mMaxLengthFio) SKIP.
   END.

   PUT UNFORMATTED
         SPACE(iOtstup) SPACE(mMaxLengthPost) SPACE(3) PADC("(подпись)",vSignLength) SKIP(1).

END PROCEDURE.
