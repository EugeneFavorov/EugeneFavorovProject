/*
               Банковская интегрированная система БИСквит
    Copyright: (C) 1992-2010 ЗАО "Банковские информационные системы"
     Filename: ptsregbrw.cqr
      Comment: Движение(регистрация) документов - вызов редактора
   Parameters:
         Uses:
      Used by:
      Created:   
     Modified:    
*/

{oracle.def}
ELSE 
IF    (LASTKEY = KEYCODE("F9") AND favail()) 
   OR LASTKEY = KEYCODE("INS") THEN
DO WITH FRAME edit:
    outr:
    do transaction on endkey undo, leave on error undo, leave:
      
        DEF VAR vTWErrLog AS LOG NO-UNDO. /* Признак: Yes - ошибка
                                          ** возвращается схемным тригером. */
        DEFINE VARIABLE vLastKeySave AS INT64 NO-UNDO.
        vLastKeySave = LASTKEY. /* сохраняем значение LASTKEY на случай его
                                   изменения в &befupd */

        {{&befupd}{&*}}
        if vLastKeySave = keycode("INS") or not avail {&file} then do:
            {acc-file.i {&*} &access-mode="c" &no-access="undo, next ACTION" &NOdef-access="/*"}
            create {&file}.
            {{&create}{&*}}
        end.
        else do:
            {acc-file.i {&*} &access-mode="w" &no-access="undo, next ACTION" &NOdef-access="/*"}
            crid = recid({&file}).
            find first {&file} where recid({&file}) = crid exclusive-lock no-wait no-error.
            if locked {&file} then do:
                run wholocks2.p (crid,(BUFFER {&file}:TABLE),"").
                undo outr, next ACTION.
            end.
            else if not avail {&file} then do:
                message "Эту запись кто-то уже удалил".
                pause 30.
                {getq first {&qry}}
                undo outr, next REFRESH.
            end.
            {{&postfind}{&*} &norepaint="/*"}
        end.
        pause 0.
        display {{&ef} &nowith="NO" {&*}} with overlay side-labels
                {ifdef {&col}} {&col} {else} */ 1 {endif} */ col centered
                row {ifdef {&editrow}} {&editrow} {else} */ level + 1 {endif} */.


        IF (LASTKEY = KEYCODE("F9")) THEN DO:
            CASE EnableDescription(NameEvent):
            WHEN 0 THEN DO:
                DISABLE Descriptions WITH FRAME edit.  
          /*      PrinalFIO:LABEL = "". 
                Descriptions:LABEL = "".  */ 
            END.
            WHEN 1 THEN DO:
                ENABLE Descriptions WITH FRAME edit.
                PrinalFIO:LABEL = "Принял ФИО". 
                Descriptions:LABEL = "Принял". 
                
            END.
            WHEN 2 THEN DO:
                ENABLE Descriptions WITH FRAME edit. 
/*                PrinalFIO:LABEL = "Выдал ФИО".
                Descriptions:LABEL = "Выдал".  */ 
                PrinalFIO:LABEL = "Принял ФИО". 
                Descriptions:LABEL = "Принял". 
            END.
            END CASE.
        END.
        ELSE DO:
            Descriptions:LABEL = "".
        END.
        
        /* Тригеры редактирования и проверки. */
        {{&eh}{&*}}

           LblUpd:
           DO
           ON ERROR  UNDO LblUpd, RETRY LblUpd
           ON ENDKEY UNDO outr,   LEAVE outr:
   
               /* Если ошибка возвращается триггером на запись,
               ** то выводим ошибку и редактируем далее. */
               IF RETRY
                  AND vTWErrLog
                  THEN 
                     MESSAGE
                     IF ERROR-STATUS:NUM-MESSAGES > 0
                        THEN ERROR-STATUS:GET-MESSAGE(1)
                        ELSE RETURN-VALUE
                     VIEW-AS ALERT-BOX ERROR BUTTONS OK.
   
               vTWErrLog = NO.

            set {{&ef} {&*}
                 &text        = "&IF DEFINED(SESSION-REMOTE) = 0 &THEN
                                 TEXT(
                                 &ENDIF"
                 &endtext     = "&IF DEFINED(SESSION-REMOTE) = 0 &THEN
                                 )
                                 &ENDIF"
                 &nowith      = "YES"
                 &noupdate    = "when new {&file}"
                 &noset       = "when no"
                 &NODISPLAY   = "yes"
                 }
            editing:
                readkey.
                {{&editing}{&*}}
                &IF DEFINED(pNoF1) = 0 &THEN
                if lastkey eq keycode("F1") then do:
                    {{&lookup}{&*}}
                end.
                else 
                &ENDIF 
                apply lastkey.
            end.

            {&workfile} 
            &IF DEFINED(ORACLE) &THEN
               /* Сохранение записи в базе (но ещё не validate),
                  mandatory поля должны быть заполнены */
               RUN saverec.p ((BUFFER {&file}:HANDLE)).
            &ENDIF
            {comment} */            

            {xattr-ed.i &level="level + 1" {&*}}
            {{&update}{&*}}

            vTWErrLog = YES.

            hide.

            /* Передается метка блока для отката. */
            &IF DEFINED (refresh)
            &THEN
                {{&refresh} {&*} &UNDO_LABEL = outr}
            &ENDIF
            crid = recid({&file}).            /* absolutely needed to */

            /* Необхоимо сбросить все ошибки
            ** перед запуском триггера на запись. */
            RUN ResetReturnValue IN h_base NO-ERROR.

            if new {&file} then do:
               RELEASE {&file} NO-ERROR.
               IF ERROR-STATUS:ERROR THEN
                  UNDO LblUpd, RETRY LblUpd.
               RUN relq. /* resync index cursor !!! */
               run open-query.
               {repq "to recid" "crid" {&qry}}
               {getq next {&qry}}
            end.
            ELSE DO:
               RELEASE {&file} NO-ERROR.
               IF ERROR-STATUS:ERROR THEN
                  UNDO LblUpd, RETRY LblUpd.
            END.
            next Refresh.
        end.
    end.
    hide.

    {{&undoedit}{&*}}
   NEXT REFRESH.
end.
{&hideframe}

