/*É´„ÂÆ¢*/

DEFINE INPUT PARAMETER iClass    AS CHARACTER NO-UNDO. /* ä´†·· §´Ô Æ‚°Æ‡† */
DEFINE INPUT PARAMETER iInstance AS HANDLE    NO-UNDO. /* í†°´®Ê† Ì™ß•¨Ø´Ô‡† ™´†··† */

{globals.i}
{intrface.get tmess}
{intrface.get trans}
{intrface.get pbase}
{intrface.get xclass}
{intrface.get date}

{tmpobj.def}
{ttretval.def}
{sh-defs.i}

DEFINE VARIABLE mFilterTable AS HANDLE      NO-UNDO. /* Å„‰•‡ ‚†°´®ÊÎ §´Ô ‰®´Ï‚‡†  */
DEFINE VARIABLE mBuffer      AS HANDLE      NO-UNDO. /* Å„‰•‡ ‚†°´®ÊÎ              */

DEFINE VARIABLE mOpDate     AS DATE      NO-UNDO.
DEFINE VARIABLE mOk         AS LOGICAL     NO-UNDO.

DEFINE VARIABLE mInt       AS INT64     NO-UNDO.
DEFINE VARIABLE mCnt       AS INT64     NO-UNDO.
DEFINE VARIABLE mString    AS CHARACTER NO-UNDO.
DEFINE VARIABLE mOst91315  AS DECIMAL   NO-UNDO.
DEFINE VARIABLE mOst47425  AS DECIMAL   NO-UNDO.
DEFINE VARIABLE mKoeff     AS DECIMAL   NO-UNDO.
DEFINE VARIABLE mRez       AS DECIMAL   NO-UNDO.


DEFINE BUFFER acct91315 FOR acct.
DEFINE BUFFER acct47425 FOR acct.
OS-DELETE VALUE("debuglog.txt").

DEFINE VARIABLE fstr AS CHARACTER INIT 
"91315810001400010163     @0500;47425810201400023179     @0500;4159-àÉ,
91315810101400010131     @0500;47425810401400050379     @0500;4259-àÉ,
91315810001400010134     @0500;47425810401400050382     @0500;4433-àÉ,
91315810705000000002     @0500;47425810905000000005     @0500;45-10287-à-Ñë,
91315810801400010101     @0500;47425810601400050357     @0500;4671-àÉ,
91315810201400010138     @0500;47425810601400050386     @0500;4689-àÉ,
91315810501400010139     @0500;47425810901400050387     @0500;4731-àÉ,
91315810501400010142     @0500;47425810501400050389     @0500;4838-àÉ,
91315810801400010143     @0500;47425810901400050390     @0500;4859-àÉ,
91315810401400010145     @0500;47425810201400050391     @0500;4921-àÉ,
91315810001400010118     @0500;47425810001400050368     @0500;4924-àÉ,
91315810201400010170     @0500;47425810401400050405     @0500;5055-àÉ,
91315810101400010157     @0500;47425810401400050395     @0500;5058-àÉ,
91315810001400010147     @0500;47425810501400050392     @0500;5077-àÉ,
91315810605960010245     @0500;47425810305960011679     @0500;5102-àÉ,
91315810501400010171     @0500;47425810701400050406     @0500;5141-àÉ,
91315810301400010177     @0500;47425810001400050410     @0500;5163-àÉ,
91315810301400010148     @0500;47425810801400050393     @0500;5187-àÉ,
91315810459660010209     @0500;47425810159660011604     @0500;52-10201-à-ÑÉ,
91315810105960010208     @0500;47425810759660011596     @0500;52-10202-àÉ,
91315810105960010211     @0500;47425810705960011596     @0500;52-10205-àÉ,
91315810405960010209     @0500;47425810259660011601     @0500;52-10206-à-Éè,
91315810705960010213     @0500;47425810359660011608     @0500;52-10207-à-ÑÉ,
91315810405960010212     @0500;47425810559660011602     @0500;52-10208-à-Éè,
91315810205960010218     @0500;47425810659660011599     @0500;52-10209-à-Éè,
91315810905960010217     @0500;47425810359660011611     @0500;52-10210-àÉ,
91315810005960010214     @0500;47425810459660011595     @0500;52-10212-àÉ,
91315810905960010220     @0500;47425810659660011612     @0500;52-10213-à-ÑÉ,
91315810605960010216     @0500;47425810059660011607     @0500;52-10214-à-Éè,
91315810505960010219     @0500;47425810459660011605     @0500;52-10215-à-ÑÉ,
91315810205960010221     @0500;47425810959660011600     @0500;52-10216-àÉ,
91315810405960010225     @0500;47425810859660011603     @0500;52-10217-à-ÑÉ,
91315810505960010222     @0500;47425810759660011606     @0500;52-10219-àÉ,
91315810805960010223     @0500;47425810059660011610     @0500;52-10220-àÉ,
91315810005960010230     @0500;47425810959660011613     @0500;52-10221-à-ÑÉ,
91315810105960010224     @0500;47425810359660011598     @0500;52-10222-à-Éè,
91315810005960010227     @0500;47425810405960011595     @0500;52-10223-àÉ,
91315810705960010226     @0500;47425810659660011609     @0500;52-10224-àÉ,
91315810605960010229     @0500;47425810859660011616     @0500;52-10227-à-Éè,
91315810305960010228     @0500;47425810259660011614     @0500;52-10228-àÉ-åëä,
91315810305960010231     @0500;47425810559660011615     @0500;52-10235-àÉ-åëä-ëîä,
91315810905960010233     @0500;47425810405960011605     @0500;52-10237-àÉ,
91315810805960010236     @0500;47425810005960011607     @0500;52-10238-àÉ,
91315810605960010232     @0500;47425810705960011606     @0500;52-10241-àÉ,
91315810205960010234     @0500;47425810105960011604     @0500;52-10248-àÉ,
91315810105960010237     @0500;47425810805960011629     @0500;52-10250-àÉ,
91315810405960010238     @0500;47425810805960011632     @0500;52-10251-àÉ-åëä,
91315810705960010242     @0500;47425810505960011660     @0500;52-10253-àÉ-è-ëîä,
91315810105960010240     @0500;47425810405960011647     @0500;52-10254-àÉ,
91315810705960010239     @0500;47425810305960011637     @0500;52-10255-àÉ,
91315810405960010241     @0500;47425810705960011648     @0500;52-10256-àÉ,
91315810005960010243     @0500;47425810305960011666     @0500;52-10257-àÉ,
91315810705960010268     @0500;47425810305960011763     @0500;52-10258-à-Éè,
91315810505960010251     @0500;47425810205960011685     @0500;52-10259-àÉ,
91315810805960010252     @0500;47425810505960011686     @0500;52-10260-àÉ-ëîä,
91315810705960010255     @0500;47425810905960011697     @0500;52-10261-àÉ-ëîä,
91315810105960010253     @0500;47425810405960011692     @0500;52-10262-àÉ-ëîä,
91315810605960010258     @0500;47425810105960011714     @0500;52-10263-à-Éè,
91315810405960010254     @0500;47425810305960011695     @0500;52-10264-àÉ,
91315810305960010257     @0500;47425810805960011713     @0500;52-10265-à-Éè,
91315810205960010263     @0500;47425810005960011746     @0500;52-10266-àÉ-è,
91315810005960010256     @0500;47425810505960011712     @0500;52-10267-àÉ,
91315810705960010271     @0500;47425810505960011770     @0500;52-10268-àÉ-è-ëîä,
91315810905960010259     @0500;47425810105960011730     @0500;52-10269-àÉ-åëä-ëîä,
91315810305960010260     @0500;47425810705960011732     @0500;52-10270-àÉ-ëîä,
91315810605960010261     @0500;47425810205960011740     @0500;52-10271-àÉ-ëîä,
91315810005960010272     @0500;47425810805960011771     @0500;52-10272-àÉ,
91315810505960010264     @0500;47425810305960011747     @0500;52-10273-à-Ñçñ,
91315810905960010262     @0500;47425810705960011745     @0500;52-10274-àÉ,
91315810405960010267     @0500;47425810805960011755     @0500;52-10275-àÉ-ëîä,
91315810805960010265     @0500;47425810605960011751     @0500;52-10276-àÉ-ëîä,
91315810105960010266     @0500;47425810505960011754     @0500;52-10277-àÉ-ëîä,
91315810005960010269     @0500;47425810805960011768     @0500;52-10278-àÉ-åëä,
91315810405960010270     @0500;47425810105960011769     @0500;52-10279-àÉ,
91315810305960010273     @0500;47425810205960011779     @0500;52-10280-àÉ,
91315810605960010274     @0500;47425810605960011780     @0500;52-10281-àÉ-ëîä,
91315810105960010279     @0500;47425810405960011812     @0500;52-10282-àÉ-è,
91315810905960010275     @0500;47425810705960011800     @0500;52-10283-àÉ-ëîä,
91315810505960010277     @0500;47425810505960011806     @0500;52-10284-àÉ-ëîä,
91315810205960010276     @0500;47425810605960011803     @0500;52-10285-àÉ-ëîä,
91315810805960010278     @0500;47425810105960011811     @0500;52-10286-àÉ-ëîä,
91315810805960010281     @0500;47425810605960011816     @0500;52-10288-àÉ,
91315810505960010280     @0500;47425810705960011813     @0500;52-10289-à-Éè,
91315810405960010283     @0500;47425810905960011820     @0500;52-10290-àÉ,
91315810005960010285     @0500;47425810405960011841     @0500;52-10291-àÉ-ëîä,
91315810305960010286     @0500;47425810705960011842     @0500;52-10293-àÉ-åëä,
91315810105960010282     @0500;47425810505960011819     @0500;52-10294-àÉ-åëä,
91315810705960010284     @0500;47425810205960011821     @0500;52-10295-à-Éè,
91315810405000000001     @0500;47425810705000000001     @0500;52-10297-àÉ,
91315810605960010287     @0500;47425810605960011845     @0500;52-10299-àÉ,
91315810905960010288     @0500;47425810905960011846     @0500;52-10300-àÉ-ëîä,
91315810601400010149     @0500;47425810101400023172     @0500;5243-àÉ,
91315810805960010249     @0500;47425810605960011683     @0500;52-7733-àÉ-Ñ,
91315810205960010250     @0500;47425810905960011684     @0500;52-7854-àÉ-Ñ,
91315810505960010248     @0500;47425810305960011682     @0500;5693-àÉ,
91315810205960010247     @0500;47425810005960011681     @0500;6807-àÉ-Ñ,
91315810905960010246     @0500;47425810705960011680     @0500;6820-àÉ-Ñ,
91315810305960010244     @0500;47425810005960011678     @0500;7644-àÉ-Ñ,
91315810205960010205     @0500;47425810305960011268     @0500;52-10127-à-ÑÉ,
91315810505960010206     @0500;47425810205960011339     @0500;52-10149-à-Ñçñ,
91315810605960010203     @0500;47425810505960010991     @0500;52-10096-à-ÑÉ,
91315810805960010207     @0500;47425810205960011423     @0500;52-10173-à-ÑÉ,
91315810905960010204     @0500;47425810805960011263     @0500;52-10112-à-ÑÉ"
   NO-UNDO.

/*fstr = "91315810001400010118     @0500;47425810001400050368     @0500;52-10112-à-ÑÉ"*/.

fstr = REPLACE(REPLACE(fstr,CHR(10),""),CHR(13),"").

DEFINE VARIABLE mi AS INTEGER NO-UNDO.
RUN _CreateFilterTable IN h_trans (OUTPUT mFilterTable).
   
mFilterTable:ADD-NEW-FIELD ("sod","character").
mFilterTable:ADD-NEW-FIELD ("acct_db","character").
mFilterTable:ADD-NEW-FIELD ("acct_cr","character").
mFilterTable:ADD-NEW-FIELD ("amt_rub","decimal").
   
mFilterTable:ADD-INDEX-FIELD("iacct","acct_mov").

/* ëÆß§†≠®• ‚†°´®ÊÎ */
mFilterTable:TEMP-TABLE-PREPARE("FilterTable") NO-ERROR.

RUN Fill-ProgressErr IN h_tmess ("").
IF ERROR-STATUS:ERROR
   OR NOT mFilterTable:PREPARED THEN
   RETURN.


DEFINE FRAME iParam 
   mKoeff   LABEL "äÆÌ‰‰. ‡•ß.(%%) "
   WITH CENTERED SIDE-LABELS ROW 10 1 COL OVERLAY TITLE COLOR bright-white "[ äÆÌ‰‰®Ê®•≠‚ ‡•ß•‡¢®‡Æ¢†≠®Ô ¢ %%]".

PAUSE 0.
UPDATE mKoeff
   WITH FRAME iParam. 
IF LAST-EVENT:FUNCTION  EQ "END-ERROR" THEN 
DO:
   HIDE FRAME iParam NO-PAUSE.
   RETURN.
END.

   
mBuffer = mFilterTable:DEFAULT-BUFFER-HANDLE.
mBuffer:FIND-FIRST() NO-ERROR.
mOpDate = GetBaseOpDate().

DO mi = 1  TO NUM-ENTRIES(fstr,","):
   RELEASE acct47425.
   RELEASE acct91315.
   FIND acct91315 WHERE acct91315.acct EQ ENTRY(1,ENTRY(mi,fstr),";")
      AND acct91315.currency EQ ""
      NO-LOCK NO-ERROR.
   IF ERROR-STATUS:ERROR THEN 
   DO:
      MESSAGE "†Â‚„≠£91315!" ENTRY(1,ENTRY(mi,fstr),";") ERROR-STATUS:GET-MESSAGE(1)  VIEW-AS ALERT-BOX.
   END.

   FIND acct47425 WHERE acct47425.acct EQ ENTRY(2,ENTRY(mi,fstr),";")
      AND acct47425.currency EQ ""
      NO-LOCK NO-ERROR.
   IF ERROR-STATUS:ERROR THEN 
   DO:
      MESSAGE "†Â‚„≠£47425! " ENTRY(2,ENTRY(mi,fstr),";") ERROR-STATUS:GET-MESSAGE(1) VIEW-AS ALERT-BOX.
   END.

   IF AVAILABLE acct47425 AND AVAILABLE acct91315 THEN
   DO: 
      RUN acct-pos IN h_base 
         (acct47425.acct, 
         acct47425.currency, 
         mOpDate, 
         mOpDate, 
         gop-status).
      mOst47425 = sh-bal.
      RUN acct-pos IN h_base 
         (acct91315.acct, 
         acct91315.currency, 
         mOpDate, 
         mOpDate, 
         gop-status).

      mOst91315 = sh-bal.

      mRez = (-1 * ROUND(mOst91315 * mKoeff / 100,2)) -  (-1 * mOst47425).

      IF mRez GT 0 THEN
      DO:
         mBuffer:BUFFER-CREATE().
         ASSIGN 
            mCnt                                             = mCnt + 1
            mBuffer:BUFFER-FIELD ("__filterid"):BUFFER-VALUE = mCnt
            mBuffer:BUFFER-FIELD ("sod")       :BUFFER-VALUE = "ëÆß§†≠®• êÇè ØÆ „·´Æ¢≠Î¨ Æ°Ôß†‚•´Ï·‚¢†¨ ØÆ äÑ " + ENTRY(3,ENTRY(mi,fstr),";")
            mBuffer:BUFFER-FIELD ("acct_db")    :BUFFER-VALUE = "70606810805964730200     @0500"
            mBuffer:BUFFER-FIELD ("acct_cr")   :BUFFER-VALUE = acct47425.acct
            mBuffer:BUFFER-FIELD ("amt_rub")   :BUFFER-VALUE = ABS(mRez).


/*          RUN dbgprint.p("",acct91315.acct + " " + acct47425.acct).*/
      END.
      IF mRez LT 0 THEN
      DO:
         mBuffer:BUFFER-CREATE().
         ASSIGN 
            mCnt                                             = mCnt + 1
            mBuffer:BUFFER-FIELD ("__filterid"):BUFFER-VALUE = mCnt
            mBuffer:BUFFER-FIELD ("sod")       :BUFFER-VALUE = "ëØ®·†≠®• ‡•ß•‡¢† ≠† ¢Æß¨Æ¶≠Î• ØÆ‚•‡® ØÆ äÑ "  + ENTRY(3,ENTRY(mi,fstr),";")
            mBuffer:BUFFER-FIELD ("acct_db")    :BUFFER-VALUE = acct47425.acct
            mBuffer:BUFFER-FIELD ("acct_cr")   :BUFFER-VALUE = "70601810505962820200     @0500"
            mBuffer:BUFFER-FIELD ("amt_rub")   :BUFFER-VALUE = ABS(mRez).


/*          RUN dbgprint.p("",acct91315.acct + " " + acct47425.acct).*/
      END.

   END.
END.

   IF mCnt NE 0 THEN   
   RUN g-fltr.p (iInstance,
                 mFilterTable,
                 "",
                 OUTPUT mOk).


{intrface.del}

IF mOk NE YES THEN
   RETURN {&RET-ERROR}.
