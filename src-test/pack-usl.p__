/*
               ОАО "Плюс Банк"
    Copyright: 
     Filename: kredprodtranz.p
      Comment: Ищет сумму которую следует списать с клиента по договору
   Parameters: 
         Uses:
      Used by:
      Created: kau
     Modified: 
*/

{globals.i}
{sh-defs.i}
{ksh-defs.i NEW}

DEFINE INPUT  PARAMETER iDate    AS DATE        NO-UNDO.
DEFINE INPUT  PARAMETER iOprid   AS RECID       NO-UNDO.

DEF VAR acctBal     AS DEC  NO-UNDO.
DEF VAR maxacctBal  AS DEC  NO-UNDO.
DEF VAR sumKom      AS DEC  NO-UNDO.
DEF VAR vSummSp     AS DEC  NO-UNDO.
DEF VAR vAcct       AS CHAR NO-UNDO.
DEF VAR vAcctFirst  AS CHAR NO-UNDO.
DEF VAR iDateN      AS DATE NO-UNDO.
DEF VAR iDateX      AS DATE NO-UNDO.



iDateN = DATE("01/" + STRING(MONTH(iDate)) + '/' + STRING(YEAR(iDate))).
MESSAGE "Создавать документ в случае отсутствия средств?" VIEW-AS ALERT-BOX QUESTION BUTTONS YES-NO-CANCEL TITLE "" UPDATE choice AS LOGICAL.
IF choice EQ ?
THEN LEAVE.
RUN SetSysConf IN h_base ("пакетсозддок", STRING(choice)).



FOR EACH cust-corp WHERE cust-corp.date-out > iDAte OR cust-corp.date-out EQ ?
NO-LOCK:
	vSummSp = 0.
	maxAcctBal = 0.
	FIND LAST tmpsigns WHERE tmpsigns.file-name EQ 'cust-corp'
						AND tmpsigns.code EQ 'Пакет'
						AND tmpsigns.surrogate EQ string(cust-corp.cust-id)
						AND tmpsigns.since < iDateN
	NO-LOCK NO-ERROR.

	IF NOT AVAIL tmpsigns OR tmpsigns.xattr-value EQ ''
	THEN NEXT.
	FIND FIRST commission WHERE commission.commission BEGINS "Pac"
							AND commission.name-comm[1] BEGINS 'Пакет услуг ' + tmpsigns.xattr-value
	NO-LOCK NO-ERROR.
	FIND LAST comm-rate WHERE comm-rate.commission EQ commission.commission
						AND comm-rate.since <= iDate
	NO-LOCK NO-ERROR.
	IF AVAIL comm-rate THEN sumKom = comm-rate.rate-comm.
	FOR EACH acct WHERE acct.cust-cat EQ 'Ю'
					AND acct.cust-id EQ cust-corp.cust-id
                    AND acct.filial-id EQ shFilial
					AND acct.contract EQ 'Расчет'
					AND acct.currency EQ ''
					AND (acct.close-date EQ ?
					OR acct.close-date > iDate
						)
	NO-LOCK
	BREAK BY acct.close-date BY acct.acct:
	    FOR EACH op-entry WHERE op-entry.op-date >= iDateN
	                   AND op-entry.op-date <= iDate
	                   AND op-entry.acct-db EQ acct.acct
	                   AND op-entry.acct-cr BEGINS '47423'
	                   AND NOT (op-entry.op-status BEGINS 'А')
	    NO-LOCK:
	        FIND FIRST op WHERE op.op EQ op-entry.op NO-LOCK.
	        IF AVAIL op AND op.op-kind EQ '1617'
	        THEN DO:
	            vSummSp = vSummSp + op-entry.amt-rub.
	        END.
	    END. 
		RUN acct-pos IN h_base (acct.acct, '', iDate, iDate, ?).
		acctBal = abs(sh-bal).
		vSummSp = SumKom - vSummSp.
		IF acctBal >= sumKom
		THEN DO:
			vAcct = acct.acct.
			LEAVE.
		END.
		IF maxAcctBal <= acctBal
        THEN DO:
            vAcctFirst = acct.acct.
        END.
	END.
	IF acctbal < sumKom
	THEN vAcct = vAcctFirst.
    IF vSummSp <= 0 
    THEN NEXT.

/*===================== fev =====================*/
    IF tmpsigns.xattr-value = "Стартовый+"
       AND (
           (
             (INT(MONTH(DATE(tmpsigns.since))) = 10)
/*             AND
             (INT(MONTH(DATE(iDate))) < INT(MONTH(ADD-INTERVAL(DATE(tmpsigns.since), +3, "months"))))
             AND
             (INT(YEAR(DATE(iDate))) = INT(YEAR(DATE(tmpsigns.since)))) */
           )
           OR
           (
             (INT(MONTH(DATE(tmpsigns.since))) <> 11)
             AND
             (INT(MONTH(DATE(tmpsigns.since))) <> 12)
             AND
             (INT(MONTH(DATE(iDate))) < INT(MONTH(ADD-INTERVAL(DATE(tmpsigns.since), +3, "months"))))
             AND
             (INT(YEAR(DATE(iDate))) = INT(YEAR(DATE(tmpsigns.since))))
           )
           OR
           (
             (
              (INT(MONTH(DATE(tmpsigns.since))) = 11)
              OR
              (INT(MONTH(DATE(tmpsigns.since))) = 12)
             )
             AND
             (INT(MONTH(DATE(iDate))) < INT(MONTH(ADD-INTERVAL(DATE(tmpsigns.since), +3, "months"))))
             AND
             (INT(YEAR(DATE(iDate))) = INT(YEAR(DATE(tmpsigns.since))) + 1)
           )
           )
    THEN NEXT.
    ELSE 
       DO:
          RUN SetSysConf IN h_base ("пакетсуммсп", STRING(vSummSp)).
          RUN SetSysConf IN h_base ("пакетсумм", STRING(sumKom)).
          RUN SetSysConf IN h_base ("пакетсчет", STRING(vAcct)).

          RUN g-trans.p (iDate,iOprid).
       END.
/*===================== end =====================*/

END.



FOR EACH person WHERE cust-corp.date-out > iDAte OR cust-corp.date-out EQ ?
NO-LOCK:
    vSummSp = 0.
    maxAcctBal = 0.
    FIND LAST tmpsigns WHERE tmpsigns.file-name EQ 'person'
                         AND tmpsigns.code EQ 'Пакет'
                         AND tmpsigns.surrogate EQ string(person.person-id)
                         AND tmpsigns.since < iDateN
    NO-LOCK NO-ERROR.

    IF NOT AVAIL tmpsigns OR tmpsigns.xattr-value EQ '' 
    THEN NEXT.
    FIND FIRST commission WHERE commission.commission BEGINS "Pac"
                            AND commission.name-comm[1] BEGINS 'Пакет услуг ' + tmpsigns.xattr-value
    NO-LOCK NO-ERROR.
    FIND LAST comm-rate WHERE comm-rate.commission EQ commission.commission
                        AND comm-rate.since <= iDate
    NO-LOCK NO-ERROR.
    IF AVAIL comm-rate THEN sumKom = comm-rate.rate-comm.
    FOR EACH acct WHERE acct.cust-cat EQ 'Ч'
                    AND acct.cust-id EQ person.person-id
                    AND acct.filial-id EQ shFilial
                    AND acct.contract EQ 'Расчет'
                    AND acct.currency EQ ''
                    AND (acct.close-date EQ ?
                    OR acct.close-date > iDate
                        )
    NO-LOCK
    BREAK BY acct.close-date BY acct.acct:
        FOR EACH op-entry WHERE op-entry.op-date >= iDateN
                       AND op-entry.op-date <= iDate
                       AND op-entry.acct-db EQ acct.acct
                       AND op-entry.acct-cr BEGINS '47423'
                       AND NOT (op-entry.op-status BEGINS 'А')
        NO-LOCK:
            FIND FIRST op WHERE op.op EQ op-entry.op
                AND op.op-kind EQ '1617' NO-LOCK.
            IF AVAIL op THEN
            DO:
                vSummSp = vSummSp + op-entry.amt-rub.
            END.
        END. 
        RUN acct-pos IN h_base (acct.acct, '', iDate, iDate, ?).
        acctBal = abs(sh-bal).
        vSummSp = SumKom - vSummSp.
        IF acctBal >= sumKom
        THEN DO:
            vAcct = acct.acct.
            LEAVE.
        END.
        IF maxAcctBal <= acctBal
        THEN DO:
            vAcctFirst = acct.acct.
        END.
    END.
    IF acctbal < sumKom
    THEN vAcct = vAcctFirst.
    IF vSummSp <= 0 
    THEN NEXT.
     
    RUN SetSysConf IN h_base ("пакетсуммсп",STRING(vSummSp)).
    RUN SetSysConf IN h_base ("пакетсумм",STRING(sumKom)).
    RUN SetSysConf IN h_base ("пакетсчет",STRING(vAcct)).

    RUN g-trans.p (iDate,iOprid).

END.