                        /* Формирование номера договора. */
mDocRef = loan.doc-ref.
                        /* Поиск клиента - владельца договора. */
IF CAN-DO("1,4,5,7", STRING(n-frm))
THEN DO:
   vAcctTypeChar = GetMainAcctRole({&file}.class-code, {&file}.contract).
                        /* Поиск счета по роли. */
   RUN RE_L_ACCT IN h_loan (
      {&file}.contract,
      {&file}.cont-code,
      vAcctTypeChar,
      {&file}.since,
      BUFFER loan-acct
   ).
                        /* Форматирование счета */
   cacct =  IF AVAIL loan-acct
               THEN TRIM(ENTRY(1,loan-acct.acct,"@"))
               ELSE "".
END.

IF CAN-DO("1,3,7", STRING(n-frm))
THEN DO:
                        /* Определение суммы процентов. */
   RUN Summ_pr (
      OUTPUT e-date,
      OUTPUT sum-term,
      BUFFER term-obl
   ).
                        /* Признак просрочки. */
   RUN Summ_Expire (
      OUTPUT summ,
      OUTPUT prosr
   ).
END.
                        /* Информация по форме с ПОС'ами */
IF CAN-DO("8", STRING(n-frm)) THEN
DO:
   ASSIGN
      mPosCode = LnInBagOnDate (loan.contract,loan.cont-code,loan.since)
      mPosName = fGetPosName (mPosCode)
   .

   /* Получаем дату привязки действующего ПОС'а, если договор
   ** привязан к ПОС'у */
   IF mPosCode <> ? THEN
   DO:
      FIND LAST term-obl WHERE term-obl.contract      =  loan.contract
                           AND term-obl.cont-code     =  loan.cont-code
                           AND term-obl.idnt          =  128
                           AND term-obl.end-date      <= loan.since
                           AND term-obl.lnk-cont-code =  mPosCode
      NO-LOCK NO-ERROR.
      IF AVAIL term-obl THEN
         mPosDate = term-obl.end-date.
   END.
   ELSE
      ASSIGN
         mPosCode = ""
         mPosName = ""
         mPosDate = ?
      .
END.
                        /* Остаток на кредитном (депозитном) договоре */
IF n-frm =  3
THEN RUN STNDRT_PARAM IN h_loan (
   loan.contract,       /* Назначение договора */
   loan.cont-code,      /* Номер договора */
   0,                   /* Код параметра */
   loan.since,          /* Дата состояния догора */
   OUTPUT balsum,       /* Сумма параметра */
   OUTPUT vDbOperDec,   /* Сумма дебетовых операций */
   OUTPUT vCrOperDec    /* Сумма кредитовых операций */
).
                        /* Редактирование допреквизитов */
IF n-frm =  {&rat_num}
THEN DO:
   {xsignrat.fnd {&*}}
END.
                        /* Определение УНК коиента. */
IF n-frm = 5
OR n-frm = 6
THEN ASSIGN
   unk-klient  =  IF mFlagUNK THEN GetCustSignEx({&file}.cust-cat,
                                                 {&file}.cust-id,
                                                 "УНК")
                              ELSE ""
   unk-klient =   IF unk-klient =  ?
                     THEN ""
                     ELSE unk-klient
.
                        /* Поиск процентной ставки и суммы по договору. */
RUN st-summ (
   loan.cont-code,
   REPLACE(cacct, "-", ""),
   loan.currency,
   OUTPUT pr-stavka,
   OUTPUT summa-sdelky
).
                        /* Здесь производим отображение. */
{&norepaint}
IF FRAME-FIELD = "cacct"
THEN ASSIGN
                        /* HELP-LABEL для поля 'cacct'. */
   cacct:HELP IN FRAME browse1 = IF vContract =  'Кредит'
                                 THEN 'Ссудный счет'
                                 ELSE 'Депозитный счет'
   cacct:HELP IN FRAME browse4 = IF vContract =  'Кредит'
                                 THEN 'Ссудный счет'
                                 ELSE 'Депозитный счет'
   cacct:HELP IN FRAME browse5 = IF vContract =  'Кредит'
                                 THEN 'Ссудный счет'
                                 ELSE 'Депозитный счет'
   cacct:HELP IN FRAME browse7 = IF vContract =  'Кредит'
                                 THEN 'Ссудный счет'
                                 ELSE 'Депозитный счет'

.
IF mChkGraphP THEN
DO:
   mLCondLTTobl = FALSE.
   FOR EACH loan-cond WHERE
            loan-cond.contract    =  loan.contract
        AND loan-cond.cont-code   =  loan.cont-code
        AND loan-cond.cred-period =  "П"
   NO-LOCK:
      mSummTObl = 0.
      FIND FIRST term-obl WHERE
                 term-obl.contract  =  loan-cond.contract
             AND term-obl.cont-code =  loan-cond.cont-code
             AND term-obl.idnt      =  2
             AND term-obl.end-date  =  loan-cond.since
      NO-LOCK NO-ERROR.
   
      IF NOT AVAIL term-obl THEN
         FIND LAST term-obl WHERE
                   term-obl.contract  =  loan-cond.contract
               AND term-obl.cont-code =  loan-cond.cont-code
               AND term-obl.idnt      =  2
               AND term-obl.end-date  <= loan-cond.since
         NO-LOCK NO-ERROR.
      
      FOR EACH bb-term-obl WHERE 
               bb-term-obl.contract  =  loan-cond.contract
           AND bb-term-obl.cont-code =  loan-cond.cont-code
           AND bb-term-obl.idnt      =  3 
           AND bb-term-obl.end-date  >  loan-cond.since
      NO-LOCK:
         mSummTObl = mSummTObl + bb-term-obl.amt.
      END. 
   
      IF     AVAIL term-obl
         AND term-obl.amt-rub <> mSummTObl THEN
         mLCondLTTobl = TRUE.
   END.
END.

                        /* Определение цвета для номера договора. */
mClrDocRefFl =       mClrDocRef  <> ""
               AND   LnInBagOnDate (loan.contract, loan.cont-code, loan.since) <> ?.
CASE n-frm:
   WHEN 1
   THEN DO
   WITH FRAME BROWSE1:
      IF mClrDocRefFl
         THEN COLOR DISPLAY VALUE (mClrDocRef) mDocRef.
      IF mLCondLTTobl THEN
         COLOR DISPLAY VALUE ('BRIGHT-YELLOW') mDocRef.
      DISPLAY
         mDocRef
         e-date                  WHEN e-date <> ?
         sum-term
         {out-fmt.i cacct fmt}   WHEN cacct  <> "" @ cacct
      .
      COLOR DISPLAY
         VALUE (IF AVAIL term-obl
                  AND term-obl.end-date - loan.since <= scr
                  THEN 'BRIGHT-RED'
                  ELSE 'NORMAL')
         e-date
         sum-term
      .
      e-date:DCOLOR = 22.
      sum-term:DCOLOR = 22.
   END.
   WHEN 2
   THEN DO
   WITH FRAME BROWSE2:
      IF mClrDocRefFl
         THEN COLOR DISPLAY VALUE (mClrDocRef) mDocRef.
      IF mLCondLTTobl THEN
         COLOR DISPLAY VALUE ('BRIGHT-YELLOW') mDocRef.
      DISPLAY mDocRef.
   END.
   WHEN 3
   THEN DO
   WITH FRAME BROWSE3:
      IF mClrDocRefFl
         THEN COLOR DISPLAY VALUE (mClrDocRef) mDocRef.
      IF mLCondLTTobl THEN
         COLOR DISPLAY VALUE ('BRIGHT-YELLOW') mDocRef.
      DISPLAY
         mDocRef
         e-date                  WHEN e-date <> ?
         sum-term
      .
      COLOR DISPLAY
         VALUE (IF AVAIL term-obl
                  AND term-obl.end-date - loan.since <= scr
                  THEN 'BRIGHT-RED'
                  ELSE 'NORMAL')
         e-date
         sum-term
      .
      e-date:DCOLOR = 22.
      sum-term:DCOLOR = 22.
   END.
   WHEN 4
   THEN DO
   WITH FRAME BROWSE4:
      IF mClrDocRefFl
         THEN COLOR DISPLAY VALUE (mClrDocRef) mDocRef.
      IF mLCondLTTobl THEN
         COLOR DISPLAY VALUE ('BRIGHT-YELLOW') mDocRef.
      DISPLAY
         mDocRef
         {out-fmt.i cacct fmt}   WHEN cacct  <> "" @ cacct
      .
   END.
   WHEN 5
   THEN DO
   WITH FRAME BROWSE5:
      IF mClrDocRefFl
         THEN COLOR DISPLAY VALUE (mClrDocRef) mDocRef.
      IF mLCondLTTobl THEN
         COLOR DISPLAY VALUE ('BRIGHT-YELLOW') mDocRef.
      DISPLAY
         mDocRef
         {out-fmt.i cacct fmt}   WHEN cacct  <> "" @ cacct
      .
   END.
   WHEN 6
   THEN DO
   WITH FRAME BROWSE6:
      IF mClrDocRefFl
         THEN COLOR DISPLAY VALUE (mClrDocRef) mDocRef.
      IF mLCondLTTobl THEN
         COLOR DISPLAY VALUE ('BRIGHT-YELLOW') mDocRef.
      DISPLAY mDocRef.
   END.
   WHEN 7
   THEN DO
   WITH FRAME BROWSE7:
      IF mClrDocRefFl
         THEN COLOR DISPLAY VALUE (mClrDocRef) mDocRef.
      DISPLAY mDocRef
      name-klient
      sum-term
      prosr
      e-date
      {out-fmt.i cacct fmt}   WHEN cacct  <> "" @ cacct
      .
   END.
   WHEN 8
   THEN DO
   WITH FRAME BROWSE8:
      IF mClrDocRefFl
         THEN COLOR DISPLAY VALUE (mClrDocRef) mDocRef.
      IF mLCondLTTobl THEN
         COLOR DISPLAY VALUE ('BRIGHT-YELLOW') mDocRef.
      DISPLAY mDocRef.
   END.
END CASE.
{comment}*/
/* $LINTFILE='loan_cd.fnd' */
/* $LINTMODE='11,-9,6,3' */
/* $LINTENV ='1ut' */
/* $LINTVSS ='$/ws2-tst/bq/' */
/* $LINTUSER='soav' */
/* $LINTDATE='07/03/2017 11:27:42.824+03:00' */
/*prosignR8VA6NOxpe54vS7WA/kodw*/