   /* Значения фильтра */
DEF VAR mClassCode   LIKE term-obl.class-code NO-UNDO.      /* Класс обязательства */ 
DEF VAR mContract    LIKE loan.contract       NO-UNDO.      /* Назначение договора */
DEF VAR mContCode    LIKE loan.cont-code      NO-UNDO.      /* Номер договора */
DEF VAR mSince       LIKE loan-cond.since     NO-UNDO.      /* На дату */
DEF VAR mIdnt        LIKE term-obl.idnt       NO-UNDO.      /* Тип обязательства */
DEF VAR mSurrogate   AS CHAR                  NO-UNDO.      /* Суррогат */
DEF VAR mIsFlow      AS LOG                   NO-UNDO.      /* Признак "Течение" */
   /* Дополнительные поля */
DEF VAR mSubCodeChar AS CHAR            NO-UNDO.            /* Номер течения */
DEF VAR mNewSumm     AS DEC             NO-UNDO.            /* новая сумма */
DEF VAR old-dat      AS DATE            NO-UNDO.            /*  */
DEF VAR old-sum      AS DEC             NO-UNDO.            /*  */
DEF VAR prol         AS LOG             NO-UNDO.            /* Признак пролонгации */
DEF VAR summ-t       LIKE term-obl.amt  NO-UNDO             /* Плановая сумма */
   FORMAT ">>>,>>>,>>>,>>9.99" 
   COLUMN-LABEL "НЕПОГАШЕННЫЙ ОСТАТОК" 
   INIT 0.
DEF VAR summ-pl      AS DEC             NO-UNDO             /* Непогашенный остаток */
   FORMAT ">>>,>>>,>>>,>>9.99" 
   COLUMN-LABEL "ПЛАНОВАЯ СУММА".
DEF VAR sm-total     AS DEC             NO-UNDO             /* Итого непогашенный остаток */
   FORMAT ">>>,>>>,>>>,>>9.99" 
   COLUMN-LABEL "ПЛАНОВАЯ СУММА".
DEF VAR mStatusTo    AS CHAR            NO-UNDO.            /* Статус заявки на досрочное погашение */
DEF VAR mPreschTo    AS CHAR            NO-UNDO.            /* Что будет пересчитано - Дата или Сумма */
DEF VAR mNameType    AS CHAR            NO-UNDO.            /* Название штрафа */
DEF VAR mCurr        AS CHAR            NO-UNDO.            /* Валюта штрафа */
DEF VAR mIssue       AS CHAR            NO-UNDO.            /* Информация */
   /* Основные переменные */
DEF VAR mTitle       AS CHAR  NO-UNDO.                      /* Заголовок формы */
DEF VAR mHelpLabel   AS CHAR  NO-UNDO.                      /* Строка подсказки */
DEF VAR mFirstFrm    AS INT64   NO-UNDO.                      /* Стартовый фрейм */
DEF VAR mProlStat    AS CHAR  NO-UNDO.                      /* Значение НП ПролСтат */
DEF VAR mProlOb      AS CHAR  NO-UNDO.                      /* Значение НП ПролОб   */
DEF VAR mSvodGraph   AS LOG   NO-UNDO.                      /* yes - сводный график, ведущийся на охват. дог., no - остальные случаи */
DEF VAR mSubCodeLst  AS CHAR  NO-UNDO.                      /* Список течений */
DEF VAR mOK          AS LOG   NO-UNDO.                      /* Результат работы инструментов */

   /* Используются в инклюдниках */
DEF VAR mTmpLoanRec  AS RECID NO-UNDO.                      /* Хранится ресид, что бы не потерять в t-obl.prt */
DEF VAR mTmpStr      AS CHAR  NO-UNDO EXTENT 6.             /* Для деления строк */
DEF VAR mCounter     AS INT64   NO-UNDO.                      /* Для wordwrap */
DEF VAR mEndDate     AS DATE  NO-UNDO.                      /* Дата штрафа */
DEF VAR mNumber      AS INT64   NO-UNDO.                      /* Код штрафа */
DEF VAR mSurr        AS CHAR  NO-UNDO.                      /* Суррогат */
DEF VAR mDataSogl    AS DATE  NO-UNDO.                      /* Дата соглашения */
DEF VAR mCliName     AS CHAR  NO-UNDO.                      /* Наименование клиента */
DEF VAR mParam       AS INT64   NO-UNDO.                      /* Строка параметров */
DEF VAR mParamStr    AS CHAR  NO-UNDO.                      /* Строка параметров */
DEF VAR mCodeStr     AS CHAR  NO-UNDO.                      /* Строка кодов */
DEF VAR mSumm        AS DEC   NO-UNDO.                      /* Сумма */
DEF VAR date-end     AS DATE  NO-UNDO.                      /* Срок текущего обязательства. */
DEF VAR end-date-old AS DATE  NO-UNDO.                      /* Срок текущего обязательства. */
DEF VAR nn-old       AS INT64 NO-UNDO.                      /* Порядковый номер обязательства */
DEF VAR dat-term     AS DATE  NO-UNDO.                      /* Дата i-го срочного обязательства после редактирования */
DEF VAR dat-term2    AS DATE  NO-UNDO.                      /* Дата ПО i-го срочного обязательства после редактирования */
DEF VAR summ-t2      AS DEC   NO-UNDO.                      /* Непогаш.ост-к (промежут.) */
DEF VAR fl-d         AS LOG   NO-UNDO.                      /* Флаг формирования графика обязательств */
DEF VAR vI           AS INT64 NO-UNDO.                      /* Счетчик цикла */
DEF VAR vNn          AS INT64 NO-UNDO.                      /* Для хранения term-obl.nn */
DEF VAR vDateNew0    AS DATE  NO-UNDO.                      /* Начальное значение новой даты ПО */
DEF VAR vDateNew     AS DATE  NO-UNDO.                      /* новая дата ПО */
DEF VAR mFlCopy      AS LOG   NO-UNDO.                      /* можно копировать даты в графике гашения ссуд */
DEF VAR mFlPer       AS LOG   NO-UNDO INIT TRUE.            /* копируем по количеству периодов */
DEF VAR mPer         AS INT64 NO-UNDO FORMAT "zzzz9".       /* количество копируемых периодов */
DEF VAR mFlDate      AS LOG   NO-UNDO.                      /* копируем до даты */
DEF VAR mDate        AS DATE  NO-UNDO.                      /* дата, до которой копируем периоды */

   /* Локализация буферов */
DEF BUFFER xterm-obl   FOR term-obl.
DEF BUFFER yterm-obl   FOR term-obl.
DEF BUFFER bterm-obl   FOR term-obl.
DEF BUFFER tr-term-obl FOR term-obl.
DEF BUFFER b-term-obl  FOR term-obl.
DEF BUFFER xloan       FOR loan.
DEF BUFFER bloan       FOR loan.
DEF BUFFER bbloan      FOR loan.
DEF BUFFER bloan-cond  FOR loan-cond.
   /* Временная таблица для сбора данных по течениям */
DEF TEMP-TABLE sub-loan NO-UNDO                             
   FIELD end-date      AS DATE                              /* Даты */
   FIELD rid           AS ROWID                             /* RowId term-obl'а */
INDEX idx rid end-date.

DEF FRAME fCopy
    "Сформировать платежи по графику" SKIP
    mFlPer  LABEL "  " VIEW-AS TOGGLE-BOX
    "за" mPer  NO-LABEL "период(ов)" SKIP
    mFlDate LABEL "  " VIEW-AS TOGGLE-BOX 
    "до" mDate NO-LABEL
WITH CENTERED SIDE-LABELS OVERLAY TOP-ONLY ROW 7 TITLE COLOR bright-white "[ ВВЕДИТЕ ДАННЫЕ ]".

ON VALUE-CHANGED OF mFlPer 
DO:
   mFlDate = NOT LOGICAL(mFlPer:SCREEN-VALUE).
   DISP mFlDate WITH FRAME fCopy.
END.

ON VALUE-CHANGED OF mFlDate 
DO:
   mFlPer = NOT LOGICAL(mFlDate:SCREEN-VALUE).
   DISP mFlPer WITH FRAME fCopy.
END.
   
   /* Получим и обработаем значения фильтра */
ASSIGN
   mClassCode   = GetFltVal("mClassBrowse")
   mContract    = GetFltVal("contract")
   mContCode    = GetFltVal("cont-code")
   mIdnt        = INT64(GetFltVal("idnt"))
   mSurrogate   = GetFltVal("surrogate")
   mIsFlow      = GetFltVal("isflow") EQ "YES"
.
ASSIGN
   mSince       = DATE(GetFltVal("since"))
NO-ERROR.
IF ERROR-STATUS:ERROR THEN
   mSince       = ?.
   /* Если идентификатор term-obl не установлен на фильтре при вызове браузера,
   ** сделаем это сейчас */
IF NOT mIsFlow
   AND mIdnt EQ 0 THEN
DO:
   mIdnt = INT64(GetXattrInit(mClassCode, "idnt")).
   RUN SetFltField ("idnt", 
                    STRING(mIdnt)).
END.
   /* При вызове браузера для обработки течений данные договора берем из суррогата, 
   ** т.к. фильтр предустанавливать нельзя */
IF     mIsFlow
   AND NUM-ENTRIES(mSurrogate) GE 3 THEN
   ASSIGN
      mContract    = ENTRY(1, mSurrogate)
      mContCode    = ENTRY(2, mSurrogate)
      mIdnt        = INT64(ENTRY(3, mSurrogate))
   .

   /* Позиционируемся на договоре */
RUN RE_B_LOAN (mContract, 
               mContCode, 
               BUFFER loan). 
IF NOT AVAIL loan THEN 
   RETURN.

ASSIGN
    mSvodGraph   =     loan.cont-type EQ "Течение"          /* Для разноски по графику погашения ОД */
                   AND GetXAttrValue("loan", loan.contract + "," + loan.cont-code, "СводГрафик") EQ "Да"
    mProlStat    = FGetSetting("Пролонг", "ПролСтат", ?)
    mProlOb      = FGetSetting("Пролонг", "ПролОб"  , "")
    mHelpLabel   = " F1│F9│Ins│Del"                         /* Стандартная строка подсказки */
.

   /* Определим по классу какую(ие) форму(ы) грузить,
   ** строку подсказки и заголовок к ней */
CASE mClassCode:
   WHEN "term-obl-per" OR WHEN "term-obl-per-pr" THEN
      ASSIGN
         mFrmLst    = IF mIsFlow THEN "7" ELSE "1"
         mFirstFrm  = IF mIsFlow THEN 7   ELSE 1
         mHelpLabel = " F1│F8 - Очистить дату│F9│Ins│Del│+" + 
                     (IF GetSysConf("vHelpLabelReturn") EQ "Да" THEN "│Ctrl-Enter - Продолжить│Esc - Отмена" ELSE "")
         mHelpLabel = IF mIsFlow THEN ' F1│+' ELSE mHelpLabel
         mTitle     = "[ ГРАФИК ПЛАТЕЖЕЙ ПО ПРОЦЕНТАМ ]"
      .
   WHEN "term-obl-sum" OR WHEN "term-obl-sum-pr" THEN
      ASSIGN
         mFrmLst    = IF mIsFlow THEN "8" ELSE "2"
         mFirstFrm  = IF mIsFlow THEN 8   ELSE 2
         mHelpLabel = IF mIsFlow THEN " F1" ELSE mHelpLabel
         mTitle     = IF mIsFlow 
                         THEN "[ ГРАФИК КРЕД./ДЕПОЗ.ЛИНИИ ]"
                         ELSE "[ ПЛАНОВЫЙ ОСТАТОК ]"
      .
   WHEN "term-obl-debt" OR WHEN "term-obl-debt-pr" THEN
   DO:
      FIND LAST bloan-cond WHERE bloan-cond.contract  EQ loan.contract
                             AND bloan-cond.cont-code EQ loan.cont-code
      NO-ERROR.
      IF AVAIL bloan-cond THEN
         mFlCopy = IF GetXAttrValueEx("loan-cond", bloan-cond.contract + "," + bloan-cond.cont-code + "," + STRING(bloan-cond.since), "СхемаПлат","Дифференцированная") EQ "Дифференцированная" THEN TRUE
                   ELSE FALSE.
      ELSE
         mFlCopy = FALSE.
      ASSIGN
         mFrmLst    = IF mIsFlow THEN "4,5" ELSE "3,6"
         mFirstFrm  = IF mIsFlow THEN 4     ELSE 6
         mHelpLabel = (IF NOT mIsFlow 
                         THEN ' F1' + (IF mSvodGraph THEN '│F5 Разноска' ELSE '') + (IF mFlCopy AND NOT mSvodGraph THEN '│F5 Копировать' ELSE '') + '│F8 - Очистить дату│F9│Ins│Del│+'
                         ELSE ' F1│F3 Форма') + 
                      (IF GetSysConf("vHelpLabelReturn") = "Да" THEN '│Ctrl-Enter - Продолжить│Esc - Отмена' ELSE '')
         mHelpLabel = IF mIsFlow THEN ' F1│F3 Форма│+' ELSE mHelpLabel
         mTitle     = "[ ДОГОВОР " + 
                      (IF {assigned loan.doc-num} THEN loan.doc-num ELSE loan.doc-ref) + 
                      (IF loan.currency NE "" THEN "/" + STRING(loan.currency) ELSE "") +
                      ": ПЛАНОВОЕ ПОГАШЕНИЕ ССУДЫ ]"
      .
   END.
   WHEN "presched" THEN
      ASSIGN
         mFrmLst    = "9"
         mFirstFrm  = 9
         mHelpLabel = "F1 Просмотр│F2 Операции│F6 Фильтр│INS│F9"
         mTitle     = "[ ЗАЯВКИ НА ДОСРОЧНОЕ ПОГАШЕНИЕ ССУДЫ ]"
      .
   WHEN "term-obl-lnk" THEN
      ASSIGN
         mFrmLst    = "10"
         mFirstFrm  = 10
         mTitle     = "[ ДОГОВОР " + (IF {assigned loan.doc-num} THEN loan.doc-num ELSE loan.doc-ref) + " ]"
      .
   WHEN "term-obl-pen" THEN
      ASSIGN
         mFrmLst    = "11"
         mFirstFrm  = 11
         mHelpLabel = "Ins│F9│Del"
         mTitle     = "[ ДОГОВОР " + (IF {assigned loan.doc-num} THEN loan.doc-num ELSE loan.doc-ref) + 
                      (IF loan.currency NE "" THEN "/" + STRING(loan.currency) ELSE "") + ": ШТРАФЫ ]"
      .
   WHEN "term-obl-agrm" THEN
      ASSIGN
         mFrmLst    = "12"
         mFirstFrm  = 12
         mTitle     = "[ ИНАЯ ОФИЦИАЛЬНАЯ ИНФОРМАЦИЯ ]"
      .
   WHEN "term-obl-dspt" THEN
      ASSIGN
         mFrmLst    = "13"
         mFirstFrm  = 13
         mTitle     = "[ СПОРЫ ПО ДОГОВОРУ ]"
      .
END CASE.

PROCEDURE Select-Browse.
    h-frm[n-frm]:TITLE = mTitle.
    RETURN.
END PROCEDURE.
/* $LINTUSER='BIS' */
/* $LINTENV ='common' */
/* $LINTVSS ='$/ws3-dpl/common/bq/' */
/* $LINTDATE='05/12/2014 16:57:04.266+04:00' */
/* $LINTFILE='t-obl.def' */
/*prosignPaDbLDHutJxnF9u94TXQDQ*/